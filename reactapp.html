import React, { useState, useEffect, useRef } from 'react';
import { MapPin, Utensils, Bed, Camera, ShoppingBag, Star, Heart, ChevronDown, Plus, Trash2, Save, X, Info, Calendar, BookOpen, Wallet, CheckSquare, Phone, Snowflake, Train, Anchor, Mountain, PenTool, Coffee, Music } from 'lucide-react';

// --- Styles (Custom CSS for Animations & Patterns) ---
const customStyles = `
  @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap');

  body {
    font-family: 'Zen Maru Gothic', sans-serif;
    background-color: #FFFBF5;
    background-image:
        radial-gradient(#D7CCC8 1px, transparent 1px),
        radial-gradient(#D7CCC8 1px, transparent 1px);
    background-position: 0 0, 25px 25px;
    background-size: 50px 50px;
    overflow: hidden; /* Prevent body scroll, handle in main */
  }

  .sketch-box {
    border: 2px solid #5E4B35;
    border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
    background: white;
    box-shadow: 3px 4px 0px 0px #5E4B35;
  }

  .sketch-box:active {
    transform: translate(2px, 2px);
    box-shadow: none;
  }

  .washi-tape {
    position: absolute;
    height: 30px;
    width: 100px;
    background-color: rgba(255, 205, 210, 0.6);
    transform: rotate(-3deg);
    z-index: 10;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    left: 50%;
    top: -15px;
    margin-left: -50px;
    border-left: 2px dotted rgba(255,255,255,0.5);
    border-right: 2px dotted rgba(255,255,255,0.5);
  }

  .important-badge {
    background: #FF7043;
    color: white;
    padding: 2px 8px;
    border-radius: 12px 2px 12px 2px;
    font-size: 0.7rem;
    font-weight: 900;
    border: 1px solid #5E4B35;
    box-shadow: 1px 1px 0 #5E4B35;
    animation: pulse 2s infinite;
  }

  .lined-paper {
    background-image: repeating-linear-gradient(transparent, transparent 27px, #E0F7FA 28px);
    background-color: #FEFEFA;
    line-height: 28px;
  }

  /* Animations */
  @keyframes snow {
    0% { transform: translateY(-10px) translateX(0); opacity: 0; }
    20% { opacity: 1; }
    100% { transform: translateY(100vh) translateX(20px); opacity: 0.2; }
  }
  .snowflake {
    position: absolute;
    color: #E3F2FD;
    font-size: 1.5rem;
    opacity: 0.8;
    animation: snow 10s linear infinite;
    pointer-events: none;
  }

  @keyframes pulse {
    0% { transform: scale(1) rotate(3deg); }
    50% { transform: scale(1.05) rotate(3deg); }
    100% { transform: scale(1) rotate(3deg); }
  }

  @keyframes wiggle {
    0%, 100% { transform: rotate(-2deg); }
    50% { transform: rotate(2deg); }
  }

  .animate-wiggle {
    animation: wiggle 3s ease-in-out infinite;
  }

  .hide-scrollbar::-webkit-scrollbar { display: none; }
  .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
`;

// --- Data Constants ---
const itineraryData = [
  {
    date: "12/20", day: "六", title: "出發！前進雪國 ✈️",
    events: [
      { time: "09:10", desc: "務必抵達機場 (T1)", type: "transport", note: "提早 3 小時!", highlight: true, details: "請於09:10前抵達桃園機場第一航廈。酷航櫃台通常人多，建議提早報到。記得先填好 Visit Japan Web。" },
      { time: "12:10", desc: "酷航 TR892 起飛", type: "transport", note: "飛行約 4hr", details: "12:10 起飛，預計 17:20 抵達新千歲機場 (CTS)。機上無供餐，建議自備輕食或上機前吃飽。" },
      { time: "17:50", desc: "抵達新千歲", type: "transport", details: "入境後，搭乘 JR 快速 Airport (¥1,150) 或 巴士 (¥1,300) 前往札幌。外面很冷，記得穿外套！" },
      { time: "19:00", desc: "Check-in: Hotel Vista", type: "stay", mapLink: "https://www.google.com/maps/search/?api=1&query=Hotel+Vista+Sapporo+Odori", details: "地點方便，就在狸小路商店街後面，有屋簷遮雪。" },
      { time: "19:30", desc: "晚餐：湯咖哩 🍛", type: "food", note: "Suage+ / GARAKU", mapLink: "https://www.google.com/maps/search/?api=1&query=Suage+Plus+Sapporo", reviewLink: "https://www.google.com/search?q=Suage%2B+%E6%9C%AD%E5%B9%8C+%E9%A3%9F%E8%A8%98", details: "北海道必吃！推薦飯店附近的 Suage+ (串燒湯咖哩) 或 GARAKU。記得飯要泡進湯裡吃喔。" },
      { time: "20:30", desc: "夜間聖代 & 唐吉軻德", type: "activity", details: "體驗札幌「收尾聖代」文化。推薦：夜パフェ専門店ななかま堂。之後去逛24H唐吉軻德。" }
    ]
  },
  {
    date: "12/21", day: "日", title: "札幌市區巡禮 ⛩️",
    events: [
      { time: "08:30", desc: "諏訪神社 (買御守)", type: "spot", mapLink: "https://www.google.com/maps/search/?api=1&query=Sapporo+Suwa+Shrine", details: "北13条東駅下車。必買超可愛的「銀喉長尾山雀」御守！" },
      { time: "09:30", desc: "北海道大學", type: "spot", details: "漫步校園。必去 Marche Café & Labo 吃農場冰淇淋和布丁。" },
      { time: "12:00", desc: "叙々苑燒肉午餐 🔥", type: "food", highlight: true, note: "預約 12:00", mapLink: "https://www.google.com/maps/search/?api=1&query=Jojoen+Sapporo", details: "高級燒肉午間套餐 CP 值很高！札幌站前店。" },
      { time: "13:30", desc: "市區散步", type: "walk", details: "紅磚廳舍、時計台、六花亭札幌本店 (買伴手禮)。" },
      { time: "17:00", desc: "COCONO SUSUKINO", type: "shop", note: "晚餐：根室花丸", details: "薄野新地標。B1 根室花丸壽司記得先抽號碼牌！" },
      { time: "19:00", desc: "聖誕市集 & 電視塔", type: "spot", details: "大通公園慕尼黑聖誕市集，感受節慶氣氛。上電視塔看夜景。" }
    ]
  },
  {
    date: "12/22", day: "一", title: "登別洞爺一日遊 🚌",
    events: [
      { time: "07:40", desc: "集合：大通公園", type: "transport", highlight: true, note: "KKday 巴士", mapLink: "https://www.google.com/maps/search/?api=1&query=Odori+Park+West+3", details: "大通公園西3丁目（31號出口）。08:00 準時發車，遲到不等人的喔！" },
      { time: "09:50", desc: "登別地獄谷 ♨️", type: "spot", details: "火山地形，煙霧繚繞。走路小心地滑。" },
      { time: "11:50", desc: "昭和新山 & 熊牧場 🐻", type: "spot", details: "可以餵熊吃蘋果。午餐自理。" },
      { time: "13:40", desc: "洞爺湖", type: "spot", details: "選擇：日歸溫泉 或 遊覽船。欣賞湖光山色。" },
      { time: "19:00", desc: "JR塔夜景 (T38)", type: "spot", details: "回到札幌站。晚餐後上 T38 展望台看夜景。" }
    ]
  },
  {
    date: "12/23", day: "二", title: "旭川美瑛夢幻遊 🐧",
    events: [
      { time: "07:50", desc: "集合：札幌北口", type: "transport", highlight: true, note: "KKday 巴士", mapLink: "https://www.google.com/maps/search/?api=1&query=Sapporo+Station+North+Exit", details: "札幌站北口巴士停車場。車程較長，建議帶頸枕。" },
      { time: "10:30", desc: "旭山動物園", type: "spot", details: "必看：11:00 企鵝散步！還有北極熊和海豹。" },
      { time: "13:10", desc: "美瑛青池 & 瀑布", type: "spot", details: "冬季結冰點燈的青池，非常夢幻。" },
      { time: "15:00", desc: "精靈露台", type: "spot", details: "富良野森林裡的小木屋，像童話世界一樣。" },
      { time: "19:30", desc: "帝王蟹火鍋 🦀", type: "food", highlight: true, note: "蟹座吃到飽", details: "預約 19:30。大口吃螃蟹的時間到了！" }
    ]
  },
  {
    date: "12/24", day: "三", title: "白色聖誕夜 🎄",
    events: [
      { time: "08:30", desc: "羊之丘展望台 🐑", type: "activity", details: "免費體驗玩雪 (滑步車、做雪人)。必拍克拉克博士像。" },
      { time: "12:00", desc: "拉麵橫丁午餐", type: "food", details: "推薦：弟子屈拉麵 (魚介)、倍煎舍 (味噌)。" },
      { time: "14:00", desc: "北海道神宮", type: "spot", note: "六花亭判官大人", details: "神宮限定的現烤麻糬，熱呼呼超好吃。" },
      { time: "16:00", desc: "白色戀人公園", type: "spot", note: "聖誕點燈", mapLink: "https://www.google.com/maps/search/?api=1&query=Shiroi+Koibito+Park", details: "歐風庭園非常漂亮，16:00 後有點燈活動。" },
      { time: "18:30", desc: "聖誕晚餐：爐端燒", type: "food", highlight: true, note: "預約 Kakureya", details: "日式爐端燒，氣氛滿分。" },
      { time: "20:30", desc: "AOAO 水族館 🐠", type: "spot", details: "moyuk 商場內。可以看到跳岩企鵝。" }
    ]
  },
  {
    date: "12/25", day: "四", title: "小樽浪漫漫步 🕯️",
    events: [
      { time: "09:10", desc: "前往小樽", type: "transport", details: "搭乘 JR 快速 Airport 號 (坐右邊看海)。" },
      { time: "10:00", desc: "小樽運河 & 商店街", type: "walk", details: "北菓樓泡芙、LeTAO 蛋糕、六花亭、音樂盒堂。" },
      { time: "12:00", desc: "午餐：若雞時代", type: "food", details: "必吃炸半雞定食！皮脆多汁。" },
      { time: "16:00", desc: "藻岩山夜景", type: "spot", note: "看天氣", details: "天氣好搭纜車看夜景 (新日本三大夜景)。天氣不好去啤酒博物館。" },
      { time: "19:00", desc: "市區最後採買", type: "shop", details: "把日幣花光光！" }
    ]
  },
  {
    date: "12/26", day: "五", title: "再見北海道 👋",
    events: [
      { time: "08:30", desc: "前往機場", type: "transport", details: "退房後搭巴士或 JR 前往新千歲機場。建議最晚12:20要到機場櫃台，早點去還可以逛機場商店街(超好逛！)。" },
      { time: "10:50", desc: "機場最後一逛", type: "shop", details: "國內線航廈超好逛！哆啦A夢空中樂園、Royce 巧克力。" },
      { time: "12:00", desc: "午餐：一幻拉麵", type: "food", details: "拉麵道場內，超濃郁蝦湯。" },
      { time: "15:20", desc: "長榮 BR115 起飛", type: "transport", highlight: true, note: "19:05 抵達台北", details: "15:20 起飛，帶著滿滿的戰利品與回憶，平安回家。" }
    ]
  }
];

const guideData = [
  {
    title: "白い恋人パーク (白色戀人公園)",
    content: "這裡不只是賣餅乾的地方，更像一座雪國童話城堡！除了參觀「白色戀人」的生產線，還可以體驗親手製作愛心餅乾。冬季庭園會有盛大的點燈活動，璀璨燈光映照在歐式建築與厚厚白雪上，超級浪漫！一定要在戶外的愛心拱門拍照打卡喔！\n\n★ 歷史小知識：白色戀人的靈感來自創辦人滑雪歸來時，隨口說出「白色戀人們降臨了」。",
    tags: ["浪漫", "必去", "拍照"]
  },
  {
    title: "旭山動物園のペンギン散歩",
    content: "冬季限定的超人氣活動！這其實是為了幫國王企鵝們解決冬季運動不足的問題。看著牠們搖搖晃晃地走在雪道上，真的會被萌翻！除了企鵝，別忘了去**海豹館**看垂直圓柱水槽，海豹會像火箭一樣咻咻咻地游過去喔！",
    tags: ["動物", "旭川", "限定"]
  },
  {
    title: "小樽運河 (Otaru Canal)",
    content: "這條運河建於 1923 年，曾是北海道金融經濟中心，被稱為「北方的華爾街」。運河旁的紅磚倉庫現在都改建成了餐廳和商店。黃昏時分，煤氣燈亮起，倒映在河面上，是小樽最浪漫的時刻。\n\n★ 拍照撇步：站在「淺草橋」上可以拍到運河最經典的弧線喔！",
    tags: ["歷史", "夜景", "浪漫"]
  },
  {
    title: "Shime Parfait (收尾聖代)",
    content: "在札幌，大家聚餐喝酒後，不是吃拉麵，而是吃「聖代」來做結尾！這叫做「締めパフェ」。這些夜間聖代通常做得像藝術品一樣精緻，口味上會運用利口酒、開心果、北海道乳製品，口感層次豐富，是大人的甜點。",
    tags: ["美食", "文化", "札幌限定"]
  },
  {
    title: "登別地獄谷 (Noboribetsu Jigokudani)",
    content: "這是約一萬年前火山爆發後形成的火山口遺跡，直徑約450公尺。這裡每天湧出1萬噸的溫泉水，是登別溫泉的源頭。因為不斷冒出白色煙霧和強烈的硫磺味，讓人聯想到地獄，所以被稱為「地獄谷」。",
    tags: ["自然", "溫泉", "壯觀"]
  },
  {
    title: "森林精靈露台 (Ningle Terrace)",
    content: "位於新富良野王子飯店旁的森林手工藝村。「Ningle」在北海道原住民愛努語中是「住在森林裡的小矮人」的意思。一間間木屋散落在森林中，當夜幕低垂點燈後，真的就像精靈居住的夢幻國度。",
    tags: ["富良野", "夢幻", "手作"]
  },
  {
    title: "札幌電視塔 (Sapporo TV Tower)",
    content: "建於1957年，位於大通公園東側，是札幌的地標。高147.2公尺，從90公尺高的展望台可以俯瞰整個大通公園，特別是冬季雪祭或聖誕點燈時，景色絕美。據說在展望台的「怖窗」(傾斜窗)往下看，會讓人腳底發癢喔！",
    tags: ["地標", "夜景", "歷史"]
  }
];

// --- Helper Components ---
const IconCircle = ({ children, colorClass }) => (
<div className={`w-10 h-10 rounded-full flex items-center justify-center mb-1 transition-all group-hover:bg-[#E3F2FD] ${colorClass || '' }`}>
    {children}
</div>
);

const SectionTitle = ({ icon, title, subColor }) => (
<div className="text-center mb-6 mt-4 relative">
    <span className="absolute -top-6 -left-2 text-4xl transform -rotate-12 opacity-50">{icon}</span>
    <h2 className={`inline-block relative z-10 bg-white px-6 py-2 sketch-box text-[#5E4B35] font-black text-lg transform rotate-1`}>
        {title}
    </h2>
</div>
);

// --- Main App Component ---
export default function App() {
  const [activeTab, setActiveTab] = useState('plan');

  // Plan State
  const [currentDayIndex, setCurrentDayIndex] = useState(0);
  const [expandedEvents, setExpandedEvents] = useState({});

  // Wallet State
  const [exchangeRate, setExchangeRate] = useState(0.201);
  const [calcInput, setCalcInput] = useState('');
  const [calcResultJpy, setCalcResultJpy] = useState(0);
  const [calcResultTwd, setCalcResultTwd] = useState(0);
  const [expenseItem, setExpenseItem] = useState('');
  const [expenses, setExpenses] = useState([]);
  const [photoPreview, setPhotoPreview] = useState(null);

  // Lists State
  const [todos, setTodos] = useState([
    { text: "護照 (效期6個月以上) 📕", done: false },
    { text: "Visit Japan Web 截圖 📱", done: false },
    { text: "eSIM 設定完成 📶", done: false },
    { text: "日幣現金 & 信用卡 💴", done: false },
    { text: "旅遊保險單 📄", done: false },
    { text: "防滑雪靴 & 手套 🧤", done: false }
  ]);
  const [newTodo, setNewTodo] = useState('');
  const [memo, setMemo] = useState('');

  // Effects for Persistence
  useEffect(() => {
    const savedExpenses = localStorage.getItem('expenses_book_2025_react');
    if (savedExpenses) setExpenses(JSON.parse(savedExpenses));

    const savedTodos = localStorage.getItem('todo_book_2025_react');
    if (savedTodos) setTodos(JSON.parse(savedTodos));

    const savedMemo = localStorage.getItem('memo_book_2025_react');
    if (savedMemo) setMemo(savedMemo);

    const savedRate = localStorage.getItem('rate_book_2025_react');
    if (savedRate) setExchangeRate(parseFloat(savedRate));
  }, []);

  useEffect(() => { localStorage.setItem('expenses_book_2025_react', JSON.stringify(expenses)); }, [expenses]);
  useEffect(() => { localStorage.setItem('todo_book_2025_react', JSON.stringify(todos)); }, [todos]);
  useEffect(() => { localStorage.setItem('memo_book_2025_react', memo); }, [memo]);
  useEffect(() => { localStorage.setItem('rate_book_2025_react', exchangeRate); }, [exchangeRate]);

  // Plan Handlers
  const toggleEvent = (index) => {
    setExpandedEvents(prev => ({ ...prev, [index]: !prev[index] }));
  };

  // Wallet Handlers
  const appendCalc = (val) => {
    const newVal = calcInput + val;
    setCalcInput(newVal);
    calculate(newVal);
  };
  const clearCalc = () => {
    setCalcInput('');
    calculate('');
  };
  const calculate = (inputVal = calcInput) => {
    if (!inputVal) {
      setCalcResultJpy(0);
      setCalcResultTwd(0);
      return;
    }
    try {
      if (/^[0-9+\-*/().\s]+$/.test(inputVal)) {
        // eslint-disable-next-line no-new-func
        const jpy = new Function('return ' + inputVal)();
        if (isFinite(jpy)) {
          setCalcResultJpy(Math.round(jpy));
          setCalcResultTwd(Math.round(jpy * exchangeRate));
        }
      }
    } catch (e) { /* ignore incomplete expression */ }
  };
  const handlePhotoUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (event) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          const maxSize = 300;
          let width = img.width;
          let height = img.height;
          if (width > height) { if (width > maxSize) { height *= maxSize / width; width = maxSize; } }
          else { if (height > maxSize) { width *= maxSize / height; height = maxSize; } }
          canvas.width = width;
          canvas.height = height;
          ctx.drawImage(img, 0, 0, width, height);
          setPhotoPreview(canvas.toDataURL('image/jpeg', 0.6));
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    }
  };
  const addExpense = () => {
    if (!expenseItem || calcResultJpy <= 0) {
      alert("記得輸入項目和金額喔！💰");
      return;
    }
    const newExpense = {
      id: Date.now(),
      item: expenseItem,
      amount: calcResultJpy,
      image: photoPreview,
      date: new Date().toLocaleDateString()
    };
    setExpenses([newExpense, ...expenses]);
    setExpenseItem('');
    clearCalc();
    setPhotoPreview(null);
  };
  const deleteExpense = (id) => {
    if (window.confirm("要撕掉這頁紀錄嗎？")) {
      setExpenses(expenses.filter(ex => ex.id !== id));
    }
  };
  const clearExpenses = () => {
    if (window.confirm("確定要換新帳本嗎？(清空)")) {
      setExpenses([]);
    }
  };

  // List Handlers
  const toggleTodo = (index) => {
    const newTodos = [...todos];
    newTodos[index].done = !newTodos[index].done;
    setTodos(newTodos);
  };
  const addTodo = () => {
    if (newTodo.trim()) {
      setTodos([...todos, { text: newTodo.trim(), done: false }]);
      setNewTodo('');
    }
  };
  const removeTodo = (index) => {
    const newTodos = [...todos];
    newTodos.splice(index, 1);
    setTodos(newTodos);
  };

  // Helper for Icon
  const getEventIcon = (type) => {
    switch (type) {
      case 'transport': return
<Train size={14} className="text-[#5E4B35]" />;
      case 'food': return
<Utensils size={14} className="text-[#5E4B35]" />;
      case 'stay': return
<Bed size={14} className="text-[#5E4B35]" />;
      case 'spot': return
<Camera size={14} className="text-[#5E4B35]" />;
      case 'activity': return
<Star size={14} className="text-[#5E4B35]" />;
      case 'shop': return
<ShoppingBag size={14} className="text-[#5E4B35]" />;
      default: return
<div className="w-2 h-2 bg-[#5E4B35] rounded-full" />;
    }
  };

  const getEventBg = (type) => {
    switch (type) {
        case 'transport': return 'bg-[#E3F2FD]';
        case 'food': return 'bg-[#FFECB3]';
        case 'stay': return 'bg-[#FFCDD2]';
        case 'spot': return 'bg-[#C8E6C9]';
        default: return 'bg-white';
    }
  }

  return (
<div className="h-screen flex flex-col relative text-[#5E4B35] overflow-hidden">
    <style>
        {
            customStyles
        }
    </style>

    {/* Snow Effect */}
    <div className="fixed top-0 left-0 w-full h-full pointer-events-none z-0">
        {[...Array(5)].map((_, i) => (
        <div key={i} className="snowflake" style={{ left: `${10 + i * 20}%`, animationDelay: `${i}s`, fontSize: i % 2 === 0 ? '1.5rem' : '1rem' }}>❄</div>
        ))}
    </div>

    {/* Decoration */}
    <div className="fixed top-12 -right-4 z-0 opacity-20 transform rotate-12 pointer-events-none">
        <Mountain size={120} className="text-[#E3F2FD]" />
    </div>

    {/* Header */}
    <header className="bg-white/90 backdrop-blur-sm z-20 px-4 py-3 flex justify-between items-center shrink-0 mx-2 mt-2 relative sketch-box">
        <div className="washi-tape" style={{ top: '-12px', backgroundColor: 'rgba(160, 216, 239, 0.6)' }}></div>
        <div>
            <h1 className="text-xl font-black tracking-wider flex items-center gap-2">
                <span className="bg-[#FFCDD2] w-8 h-8 rounded-full flex items-center justify-center border border-[#5E4B35] text-white">冬</span>
                北海道手帳
            </h1>
            <div className="flex items-center gap-2 mt-1 ml-1">
                <span className="text-xs font-bold text-[#5E4B35]/60 bg-[#E3F2FD] px-2 py-0.5 rounded-sm transform -rotate-1">2025.12.20 - 12.26</span>
            </div>
        </div>
        <div className="w-10 h-10 flex items-center justify-center animate-wiggle bg-[#FFECB3] rounded-full border-2 border-[#5E4B35]">
            <span className="text-2xl">⛄</span>
        </div>
    </header>

    {/* Main Content */}
    <main className="flex-1 overflow-y-auto hide-scrollbar relative p-2 z-10">

        {/* PLAN TAB */}
        {activeTab === 'plan' && (
        <div className="animate-fadeIn">
            {/* Date Selector */}
            <div className="flex overflow-x-auto gap-3 pb-2 mb-4 hide-scrollbar sticky top-0 z-20 py-3 px-1 -mx-2 px-3 bg-gradient-to-b from-[#FFFBF5] via-[#FFFBF5] to-transparent">
                {itineraryData.map((item, index) => (
                <button key={index}
                        onClick={() =>
                    setCurrentDayIndex(index)}
                    className={`flex-shrink-0 w-16 py-2 text-center transition-all border-2 rounded-xl relative overflow-hidden group ${
                    currentDayIndex === index
                    ? 'bg-[#FFCDD2] border-[#5E4B35] text-[#5E4B35] shadow-[3px_4px_0_0_#5E4B35] transform -translate-y-1'
                    : 'bg-white border-[#D7CCC8] text-gray-400'
                    }`}
                    >
                    <span className="block text-[10px] font-bold mb-0">{item.date}</span>
                    <span className="text-lg font-black">{item.day}</span>
                </button>
                ))}
            </div>

            {/* Timeline */}
            <div className="relative pl-2 pr-2 mt-2 pb-8">
                <div className="absolute left-[26px] top-5 bottom-0 w-1 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNCIgaGVpZ2h0PSIyMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSIyMCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjRDdDQ0M4IiBzdHJva2Utd2lkdGg9IjQiIHN0cm9rZS1kYXNoYXJyYXk9IjEwLCAxMCIvPjwvc3ZnPg==')] bg-repeat-y z-0"></div>

                <div className="mb-8 ml-10 relative">
                    <h3 className="text-xl font-black bg-[#FFECB3] inline-block px-4 py-2 sketch-box transform -rotate-1">
                        {itineraryData[currentDayIndex].title}
                    </h3>
                </div>

                <div className="space-y-6">
                    {itineraryData[currentDayIndex].events.map((event, idx) => (
                    <div key={idx} className="relative pl-10 pb-2 group z-10">
                        {/* Icon */}
                        <div className={`absolute left-[18px] top-0 w-8 h-8 ${getEventBg(event.type)} border-2 border-[#5E4B35] rounded-full flex items-center justify-center z-20 shadow-sm`}>
                            {getEventIcon(event.type)}
                        </div>

                        {/* Card */}
                        <div className="sketch-box p-4 bg-white relative cursor-pointer active:scale-[0.98] transition-transform"
                             onClick={() =>
                            toggleEvent(idx)}
                            >
                            {event.highlight && (
                            <div className="absolute -top-3 -right-2 important-badge transform rotate-3">
                                {event.note && event.note.includes("提早") ? "重要!" : "重要集合!"}
                            </div>
                            )}

                            <div className="flex justify-between items-start mb-2">
                                <span className="inline-block bg-gray-100 text-xs font-bold px-2 py-1 rounded border border-[#D7CCC8]">{event.time}</span>
                                <ChevronDown size={16} className={`text-gray-400 transition-transform ${expandedEvents[idx] ? 'rotate-180' : '' }`} />
                            </div>

                            <h4 className="text-base font-black">{event.desc}</h4>

                            {expandedEvents[idx] && (
                            <div className="mt-4 pt-4 border-t-2 border-dashed border-[#D7CCC8] text-sm text-gray-600 font-medium leading-relaxed">
                                <p className="mb-3 whitespace-pre-line">{event.details}</p>
                                {event.note && <p className="text-xs text-[#FF7043] font-bold mb-2"><Info size={12} className="inline mr-1" />{event.note}</p>}
                                <div className="flex flex-wrap gap-2 mt-2">
                                    {event.mapLink && (
                                    <a href={event.mapLink} target="_blank" rel="noreferrer" onClick={(e) =>
                                        e.stopPropagation()} className="inline-flex items-center px-3 py-1 text-xs bg-[#E3F2FD] border-2 border-[#5E4B35] rounded-full shadow-[2px_2px_0_0_#5E4B35] active:translate-y-1 active:shadow-none transition-all">
                                        <MapPin size={12} className="mr-1" /> 📍 看地圖
                                    </a>
                                    )}
                                    {event.reviewLink && (
                                    <a href={event.reviewLink} target="_blank" rel="noreferrer" onClick={(e) =>
                                        e.stopPropagation()} className="inline-flex items-center px-3 py-1 text-xs bg-[#FFECB3] border-2 border-[#5E4B35] rounded-full shadow-[2px_2px_0_0_#5E4B35] active:translate-y-1 active:shadow-none transition-all">
                                        <Utensils size={12} className="mr-1" /> 🍴 查食記
                                    </a>
                                    )}
                                </div>
                            </div>
                            )}
                        </div>
                    </div>
                    ))}
                </div>
            </div>

            <div className="text-center mt-8 mb-4">
                <div className="inline-block bg-white border-2 border-[#5E4B35] px-4 py-2 rounded-full shadow-[3px_4px_0_0_#5E4B35] text-xs font-bold transform -rotate-1">
                    👉 點擊卡片看詳細 & 地圖喔！
                </div>
            </div>
        </div>
        )}

        {/* GUIDE TAB */}
        {activeTab === 'guide' && (
        <div className="animate-fadeIn">
            <SectionTitle icon="📖" title="旅行筆記．豆知識" />
            <div className="grid grid-cols-1 gap-6 px-1 pb-20">
                {guideData.map((item, index) => (
                <div key={index} className={`sketch-box p-6 relative bg-white mb-4 transform ${index % 2= = =0 ? '-rotate-1' : 'rotate-1' } hover:rotate-0 transition-transform`}>
                    <div className="washi-tape" style={{ top: '-12px', right: '40%', width: '80px', backgroundColor: 'rgba(168, 216, 185, 0.6)' }}></div>
                    <div className="flex gap-2 mb-3 flex-wrap">
                        {item.tags.map((t, i) => (
                        <span key={i} className="text-[10px] font-bold bg-[#FFECB3] border border-[#5E4B35] px-2 py-1 rounded-full">{t}</span>
                        ))}
                    </div>
                    <h3 className="text-xl font-black mb-3 pb-2 border-b-2 border-dashed border-[#D7CCC8] flex items-center">
                        <PenTool size={18} className="mr-2" /> {item.title}
                    </h3>
                    <div className="lined-paper p-4 rounded-lg border border-[#D7CCC8] text-sm font-medium relative shadow-inner">
                        <p className="whitespace-pre-line">{item.content}</p>
                    </div>
                </div>
                ))}
            </div>
        </div>
        )}

        {/* WALLET TAB */}
        {activeTab === 'wallet' && (
        <div className="animate-fadeIn pb-20">
            {/* Calculator */}
            <div className="sketch-box p-5 mb-6 mx-1 mt-2 relative bg-white">
                <div className="washi-tape" style={{ top: '-10px', right: '20px', left: 'auto', backgroundColor: 'rgba(255, 236, 179, 0.7)', width: '60px' }}></div>

                <div className="flex justify-between items-center mb-4">
                    <label className="text-sm font-bold flex items-center gap-2">
                        <div className="w-6 h-6 bg-[#C8E6C9] rounded-full border border-[#5E4B35] flex items-center justify-center text-xs text-white">￥</div>
                        即時匯率
                    </label>
                    <input type="number"
                           value={exchangeRate}
                           onChange={(e) => setExchangeRate(e.target.value)}
                    step="0.001"
                    className="w-20 text-center text-lg font-bold bg-[#FFFBF5] border-b-2 border-[#5E4B35] border-dashed focus:outline-none"
                    />
                </div>

                <div className="bg-[#E3F2FD]/30 rounded-lg p-3 mb-4 border-2 border-[#5E4B35] relative">
                    <input type="text"
                           value={calcInput}
                           onChange={(e) => calculate(e.target.value)}
                    placeholder="輸入算式..."
                    className="w-full bg-transparent text-xl text-right focus:outline-none mb-1 font-black font-mono"
                    />
                    <div className="flex justify-between items-end border-t-2 border-dashed border-[#D7CCC8] pt-2">
                        <span className="text-xs opacity-60 font-bold">JPY</span>
                        <span className="text-xl font-bold">{calcResultJpy.toLocaleString()}</span>
                    </div>
                    <div className="flex justify-between items-end mt-1">
                        <span className="text-xs opacity-60 font-bold">約 TWD</span>
                        <span className="text-lg font-bold text-[#FF7043]">{calcResultTwd.toLocaleString()}</span>
                    </div>
                </div>

                <div className="grid grid-cols-4 gap-2 mb-4">
                    {['+', '-', '*', '='].map((op) => (
                    <button key={op} onClick={() => op === '=' ? calculate() : appendCalc(op)} className={`h-10 sketch-box shadow-sm active:translate-y-1 active:shadow-none font-bold text-lg ${op === '=' ? 'bg-[#FFCDD2] text-white' : 'bg-white'}`}>{op}</button>
                    ))}
                </div>
                <div className="grid grid-cols-4 gap-2 mb-4">
                    {['1','2','3','/','4','5','6','C','7','8','9','0'].map(key => (
                    <button key={key} onClick={() => key === 'C' ? clearCalc() : appendCalc(key)} className={`h-10 sketch-box shadow-sm active:translate-y-1 active:shadow-none font-bold text-lg ${key === 'C' ? 'bg-[#FF7043] text-white' : 'bg-white'}`}>{key === '/' ? '÷' : key}</button>
                    ))}
                </div>

                <div className="border-t-2 border-dashed border-[#D7CCC8] pt-4 flex gap-2">
                    <input type="text"
                           value={expenseItem}
                           onChange={(e) => setExpenseItem(e.target.value)}
                    placeholder="買了什麼..."
                    className="flex-1 bg-transparent border-b-2 border-[#5E4B35] border-dashed px-2 text-sm font-bold outline-none"
                    />
                    <label className="sketch-box w-10 h-10 flex items-center justify-center bg-[#FFECB3] cursor-pointer active:scale-95">
                        <Camera size={16} />
                        <input type="file" accept="image/*" className="hidden" onChange={handlePhotoUpload} />
                    </label>
                </div>

                {photoPreview && (
                <div className="mt-3 relative w-full h-32 sketch-box p-1 rotate-1">
                    <img src={photoPreview} alt="preview" className="w-full h-full object-contain" />
                    <button onClick={() => setPhotoPreview(null)} className="absolute -top-2 -right-2 bg-[#FF7043] text-white w-6 h-6 rounded-full border-2 border-[#5E4B35] flex items-center justify-center font-bold"><X size={12} /></button>
                </div>
                )}

                <button onClick={addExpense} className="w-full bg-[#5E4B35] text-white py-3 sketch-box-fill mt-4 font-bold active:translate-y-1 flex items-center justify-center gap-2">
                    <PenTool size={16} /> 記下來
                </button>
            </div>

            {/* List */}
            <div className="px-2">
                <div className="flex justify-between items-center mb-3 border-b-2 border-[#5E4B35] pb-1">
                    <h3 className="font-bold text-lg flex items-center gap-2"><Wallet size={18} /> 支出紀錄</h3>
                    <span className="text-xs font-bold bg-white px-2 py-1 sketch-box">Total: ¥{expenses.reduce((acc, curr) => acc + curr.amount, 0).toLocaleString()}</span>
                </div>
                <ul className="space-y-3 pb-4">
                    {expenses.map((ex) => (
                    <li key={ex.id} className="sketch-box p-3 flex items-center gap-3 bg-white mb-2">
                        {ex.image
                        ? <div className="w-12 h-12 bg-gray-100 flex-shrink-0 flex items-center justify-center overflow-hidden border-2 border-[#5E4B35] rounded-lg"><img src={ex.image} alt="" className="w-full h-full object-cover" /></div>
                        : <div className="w-12 h-12 bg-[#E3F2FD] flex-shrink-0 flex items-center justify-center text-[#5E4B35] border-2 border-[#5E4B35] rounded-lg"><ShoppingBag size={20} /></div>
                        }
                        <div className="flex-1 min-w-0">
                            <div className="flex justify-between items-baseline">
                                <h4 className="text-sm font-black truncate pr-2">{ex.item}</h4>
                                <span className="font-black text-base">¥{ex.amount.toLocaleString()}</span>
                            </div>
                            <div className="flex justify-between items-center mt-1">
                                <span className="text-[10px] text-gray-500 font-bold">{ex.date}</span>
                                <span className="text-[10px] text-[#FF7043] font-bold">≈ NT$ {Math.round(ex.amount * exchangeRate).toLocaleString()}</span>
                            </div>
                        </div>
                        <button onClick={() => deleteExpense(ex.id)} className="text-gray-400 hover:text-[#FF7043] px-2"><Trash2 size={16} /></button>
                    </li>
                    ))}
                </ul>
                <button onClick={clearExpenses} className="w-full text-center text-xs opacity-50 mt-4 underline decoration-wavy">🗑️ 換一本新帳本 (清空)</button>
            </div>
        </div>
        )}

        {/* LISTS TAB */}
        {activeTab === 'lists' && (
        <div className="animate-fadeIn px-1 pb-20">
            <div className="sketch-box p-5 mb-6 mt-2 relative bg-white rotate-1">
                <div className="washi-tape" style={{ left: '20%', backgroundColor: 'rgba(168, 216, 185, 0.6)' }}></div>
                <h3 className="text-lg font-black mb-4 flex items-center gap-2 border-b-2 border-dashed border-[#D7CCC8] pb-2">
                    <CheckSquare size={20} className="text-[#C8E6C9]" /> 行李檢查表
                </h3>
                <div className="space-y-2">
                    {todos.map((todo, index) => (
                    <div key={index} className="flex items-center gap-3 bg-white p-2 rounded border-b-2 border-[#D7CCC8] border-dashed">
                        <input type="checkbox"
                               checked={todo.done}
                               onChange={() => toggleTodo(index)}
                        className="w-5 h-5 accent-[#5E4B35] cursor-pointer"
                        />
                        <span className={`text-sm font-bold flex-1 ${todo.done ? 'line-through text-gray-400 decoration-wavy' : '' }`}>{todo.text}</span>
                        <button onClick={() => removeTodo(index)} className="text-gray-300 hover:text-[#FF7043]"><X size={16} /></button>
                    </div>
                    ))}
                </div>
                <div className="mt-4 flex gap-2">
                    <input type="text"
                           value={newTodo}
                           onChange={(e) => setNewTodo(e.target.value)}
                    placeholder="還要帶..."
                    className="flex-1 bg-[#FFFBF5] border-b-2 border-[#5E4B35] px-2 text-sm font-bold outline-none"
                    />
                    <button onClick={addTodo} className="bg-[#5E4B35] text-white w-8 h-8 rounded-full border-2 border-[#5E4B35] flex items-center justify-center"><Plus size={16} /></button>
                </div>
            </div>

            <div className="sketch-box p-5 bg-[#FFF9C4] -rotate-1 relative">
                <div className="absolute -top-3 -right-2 text-2xl transform rotate-12">📝</div>
                <h3 className="text-lg font-black mb-2 flex items-center gap-2">隨手記</h3>
                <textarea value={memo}
                          onChange={(e) => setMemo(e.target.value)}
                 className="w-full h-40 bg-transparent p-2 text-sm leading-loose outline-none resize-none font-bold placeholder-[#5E4B35]/40"
                 style={{ backgroundImage: 'repeating-linear-gradient(transparent, transparent 31px, #D7CCC8 31px, #D7CCC8 32px)', lineHeight: '32px' }}
                 placeholder="輸入網址會自動變成連結喔..."
               />
            </div>
        </div>
        )}

        {/* INFO TAB */}
        {activeTab === 'info' && (
        <div className="animate-fadeIn px-2 space-y-6 pt-2 pb-20">
            <div className="sketch-box p-5 relative overflow-hidden bg-white">
                <div className="absolute -right-6 -top-6 text-[#E3F2FD] text-9xl opacity-80"><Snowflake size={120} /></div>
                <h3 className="font-black text-lg mb-2 relative z-10 flex items-center gap-2"><Snowflake size={20} className="text-blue-400" />北海道天氣</h3>
                <p className="text-sm font-bold mb-4 relative z-10">12月平均 -4°C ~ -1°C <br /> 洋蔥式穿搭最重要！室內暖氣很強。</p>
                <a href="https://www.jma.go.jp/bosai/forecast/" target="_blank" rel="noreferrer" className="inline-block bg-[#5E4B35] text-white text-xs font-bold px-4 py-2 rounded-full shadow-md hover:opacity-80 transition relative z-10">日本氣象廳</a>
            </div>

            <div className="sketch-box p-5 bg-[#FFEBEE] border-[#FFCDD2] relative">
                <div className="absolute -left-2 -top-3 text-3xl transform -rotate-12">🚑</div>
                <h3 className="font-black text-lg mb-3 pl-8">緊急聯絡</h3>
                <ul className="space-y-3 text-sm font-bold">
                    <li className="flex items-center gap-3"><span className="bg-white border-2 border-[#5E4B35] w-8 h-8 rounded-full flex items-center justify-center text-[#FF7043]"><Phone size={14} /></span> 警察局: 110</li>
                    <li className="flex items-center gap-3"><span className="bg-white border-2 border-[#5E4B35] w-8 h-8 rounded-full flex items-center justify-center text-[#FF7043]"><Plus size={14} /></span> 救護車: 119</li>
                    <li className="bg-white p-3 rounded-lg border-2 border-[#5E4B35] border-dashed mt-2">
                        <div className="mb-1 text-[10px] text-gray-500">台北駐日經濟文化代表處札幌分處</div>
                        <a href="tel:+81112222930" className="text-lg font-black flex items-center gap-2 text-[#FF7043]">+81-11-222-2930</a>
                    </li>
                </ul>
            </div>
        </div>
        )}

    </main>

    {/* Bottom Navigation */}
    <nav className="bg-white/90 backdrop-blur-md border-t-2 border-[#5E4B35] shrink-0 pb-safe z-30 relative rounded-t-[25px] shadow-[0_-4px_10px_rgba(0,0,0,0.05)]">
        <div className="flex justify-around items-center h-20">
            {['plan', 'guide', 'wallet', 'lists', 'info'].map(tab => (
            <button key={tab}
                    onClick={() =>
                setActiveTab(tab)}
                className={`nav-item flex flex-col items-center justify-center w-full h-full transition-all duration-300 group ${activeTab === tab ? 'active' : ''}`}
                >
                <IconCircle colorClass={activeTab = = =tab ? 'bg-[#FFCDD2] border-[#5E4B35] border-2' : '' }>
                    {tab === 'plan' && <MapPin size={20} />}
                    {tab === 'guide' && <BookOpen size={20} />}
                    {tab === 'wallet' && <Wallet size={20} />}
                    {tab === 'lists' && <CheckSquare size={20} />}
                    {tab === 'info' && <Info size={20} />}
                </IconCircle>
                <span className="text-[10px] font-bold capitalize">{tab}</span>
            </button>
            ))}
        </div>
    </nav>
</div>
  );
}