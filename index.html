<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>2025 åŒ—æµ·é“å†¬ã®æ—…æ‰‹å¸³ â„ï¸</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#FDFBF7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        kawaii: {
                            base: '#FDFBF7', text: '#4A4036', primary: '#FF9EAA', secondary: '#89CFF0',
                            accent: '#FFD54F', green: '#A7D7C5', purple: '#D4C1EC', card: '#FFFFFF'
                        }
                    },
                    fontFamily: { sans: ['"Zen Maru Gothic"', 'sans-serif'] },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(255, 158, 170, 0.15)',
                        'card': '0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03)',
                        'glow': '0 0 15px rgba(255, 158, 170, 0.5)' 
                    },
                    animation: { 'bounce-slow': 'bounce 3s infinite' }
                }
            }
        }
    </script>
    <style>
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        body { background-color: #FDFBF7; background-image: radial-gradient(#E5E5E5 1px, transparent 1px); background-size: 20px 20px; color: #4A4036; -webkit-tap-highlight-color: transparent; min-height: 100vh; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .tab-content { display: none; opacity: 0; transform: translateY(10px); transition: opacity 0.3s ease, transform 0.3s ease; padding-bottom: 140px; }
        .tab-content.active { display: block; opacity: 1; transform: translateY(0); }
        .kawaii-card { background: white; border-radius: 24px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); border: 2px solid #F0F0F0; transition: transform 0.2s; position: relative; overflow: hidden; }
        .timeline-line { position: absolute; left: 28px; top: 40px; bottom: 0; width: 4px; background: repeating-linear-gradient(to bottom, #E3F2FD 0, #E3F2FD 10px, transparent 10px, transparent 20px); z-index: 0; border-radius: 4px; }
        .event-details { max-height: 0; overflow: hidden; transition: max-height 0.4s cubic-bezier(0, 1, 0, 1), opacity 0.4s ease; opacity: 0; }
        .expanded .event-details { max-height: 1000px; opacity: 1; margin-top: 1rem; padding-top: 1rem; border-top: 2px dashed #F0F0F0; }
        .nav-bar-float { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 30px 30px 0 0; box-shadow: 0 -10px 40px rgba(0,0,0,0.05); border-top: 1px solid rgba(255,255,255,0.8); }
        .nav-item.active .icon-container { background-color: #FF9EAA; color: white; transform: translateY(-10px) scale(1.1); box-shadow: 0 6px 15px rgba(255, 158, 170, 0.4); }
        .snow-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; }
        .snowflake { position: absolute; color: #BDE0FE; font-size: 1rem; text-shadow: 0 0 5px rgba(255,255,255,0.8); animation: snow 15s linear infinite; }
        @keyframes snow { 0% { transform: translateY(-10px) translateX(0) rotate(0deg); opacity: 0; } 20% { opacity: 0.8; } 100% { transform: translateY(100vh) translateX(20px) rotate(360deg); opacity: 0.2; } }
    </style>
</head>
<body class="font-sans flex flex-col relative text-kawaii-text selection:bg-kawaii-primary selection:text-white">

    <div class="snow-container">
        <div class="snowflake" style="left: 10%; animation-delay: 0s;">â„</div>
        <div class="snowflake" style="left: 25%; animation-delay: 2s; font-size: 0.8rem;">â…</div>
        <div class="snowflake" style="left: 50%; animation-delay: 4s;">â„</div>
        <div class="snowflake" style="left: 75%; animation-delay: 1s; font-size: 1.2rem;">â…</div>
        <div class="snowflake" style="left: 90%; animation-delay: 3s;">â„</div>
    </div>

    <header class="sticky top-0 z-40 bg-white/80 backdrop-blur-md border-b border-white/50 shadow-sm transition-all duration-300">
        <div class="px-3 py-3 flex justify-between items-center max-w-2xl mx-auto gap-2">
            <div class="flex items-center gap-2 overflow-hidden">
                <div class="w-10 h-10 flex-shrink-0 bg-gradient-to-tr from-kawaii-secondary to-blue-50 rounded-2xl flex items-center justify-center shadow-inner text-xl relative overflow-hidden group">
                    <span class="group-hover:animate-bounce-slow inline-block">â›„</span>
                    <div class="absolute inset-0 bg-white/20 rounded-2xl"></div>
                </div>
                <div class="min-w-0">
                    <h1 class="text-base font-black tracking-wide text-gray-800 truncate leading-tight">
                        2025 åŒ—æµ·é“<br>å†¬ã®æ—…æ‰‹å¸³
                    </h1>
                </div>
            </div>
            <a href="https://docs.google.com/document/d/1WI3KNDMLUYx4P_X6-Oxj5lBcrVkfZfUeL3ah2RJeojE/edit?usp=sharing" target="_blank" class="flex-shrink-0 flex items-center gap-1.5 bg-kawaii-primary text-white pl-3 pr-4 py-2 rounded-full font-bold text-xs shadow-md shadow-pink-200 hover:shadow-glow hover:scale-105 active:scale-95 transition-all">
                <i class="fas fa-file-alt"></i> <span>çœ‹å®Œæ•´è¡Œç¨‹</span>
            </a>
        </div>
    </header>

    <main class="w-full relative max-w-2xl mx-auto p-4 z-10 pb-32">
        <div id="tab-plan" class="tab-content active">
            <div id="date-scroll" class="flex overflow-x-auto gap-3 pb-4 mb-2 hide-scrollbar sticky top-[70px] z-30 py-2 -mx-4 px-4 bg-gradient-to-b from-kawaii-base via-kawaii-base to-transparent"></div>
            <div id="itinerary-container" class="space-y-6 relative pl-2 pr-2 mt-2"></div>
            <div class="text-center mt-12 mb-8"><p class="text-xs text-gray-300 font-bold">â€”â€” æ¯ä¸€å¤©éƒ½æ˜¯æ–°çš„å†’éšª â€”â€”</p></div>
        </div>

        <div id="tab-guide" class="tab-content">
            <div class="flex items-center gap-3 mb-6">
                <h2 class="text-2xl font-black text-kawaii-text">æ—…è¡Œç­†è¨˜</h2>
                <span class="bg-kawaii-accent/30 text-yellow-700 text-xs font-bold px-2 py-1 rounded-lg">è±†çŸ¥è­˜</span>
            </div>
            <div id="guide-container" class="grid grid-cols-1 gap-5"></div>
        </div>

        <div id="tab-wallet" class="tab-content">
            <div class="bg-white rounded-[32px] p-6 shadow-soft mb-6 relative border-4 border-kawaii-primary/10">
                <div class="absolute top-4 right-6 text-kawaii-primary/20 text-6xl rotate-12"><i class="fas fa-coins"></i></div>
                
                <div class="relative z-10 flex gap-4 mb-4">
                    <div class="flex-1">
                        <label class="text-xs font-bold text-gray-400 mb-1 block tracking-wider">åŒ¯ç‡ (Rate)</label>
                        <input type="number" id="exchange-rate" value="0.201" step="0.001" class="w-full text-2xl font-black bg-transparent border-b-2 border-kawaii-primary/30 focus:border-kawaii-primary focus:outline-none text-kawaii-text" placeholder="0.201">
                    </div>
                    <div class="w-20">
                        <label class="text-xs font-bold text-gray-400 mb-1 block tracking-wider">äººæ•¸</label>
                        <div class="flex items-center">
                            <i class="fas fa-user text-kawaii-primary mr-1 text-xs"></i>
                            <input type="number" id="traveler-count" value="2" min="1" class="w-full text-2xl font-black bg-transparent border-b-2 border-kawaii-primary/30 focus:border-kawaii-primary focus:outline-none text-kawaii-text text-center" onchange="updateSplitCalc()">
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 rounded-2xl p-4 mb-4 border border-gray-100 shadow-inner">
                    <input type="text" id="calc-input" placeholder="0" class="w-full bg-transparent text-2xl text-right focus:outline-none mb-1 font-black text-kawaii-text font-mono tracking-widest">
                    <div class="flex justify-between items-end border-t border-dashed border-gray-200 pt-2">
                        <span class="text-xs text-gray-400 font-bold">JPY</span>
                        <div class="text-right">
                            <span class="text-xs text-gray-400 font-bold mr-1">ç´„ TWD</span>
                            <span id="calc-result-twd" class="text-lg font-bold text-kawaii-secondary">0</span>
                        </div>
                    </div>
                    <span id="calc-result-jpy" class="hidden">0</span>
                </div>

                <div class="grid grid-cols-4 gap-3 mb-4">
                    <button onclick="appendCalc('+')" class="h-10 rounded-xl bg-gray-50 font-bold text-gray-400 hover:bg-gray-100">+</button>
                    <button onclick="appendCalc('-')" class="h-10 rounded-xl bg-gray-50 font-bold text-gray-400 hover:bg-gray-100">-</button>
                    <button onclick="appendCalc('*')" class="h-10 rounded-xl bg-gray-50 font-bold text-gray-400 hover:bg-gray-100">Ã—</button>
                    <button onclick="appendCalc('/')" class="h-10 rounded-xl bg-gray-50 font-bold text-gray-400 hover:bg-gray-100">Ã·</button>
                    
                    <button onclick="appendCalc('7')" class="h-12 rounded-2xl bg-white shadow-card font-black text-lg text-kawaii-text active:scale-95 transition-transform">7</button>
                    <button onclick="appendCalc('8')" class="h-12 rounded-2xl bg-white shadow-card font-black text-lg text-kawaii-text active:scale-95 transition-transform">8</button>
                    <button onclick="appendCalc('9')" class="h-12 rounded-2xl bg-white shadow-card font-black text-lg text-kawaii-text active:scale-95 transition-transform">9</button>
                    <button onclick="clearCalc()" class="h-12 rounded-2xl bg-red-50 text-red-400 font-black text-lg active:scale-95 transition-transform">C</button>
                    <button onclick="appendCalc('4')" class="h-12 rounded-2xl bg-white shadow-card font-black text-lg text-kawaii-text active:scale-95 transition-transform">4</button>
                    <button onclick="appendCalc('5')" class="h-12 rounded-2xl bg-white shadow-card font-black text-lg text-kawaii-text active:scale-95 transition-transform">5</button>
                    <button onclick="appendCalc('6')" class="h-12 rounded-2xl bg-white shadow-card font-black text-lg text-kawaii-text active:scale-95 transition-transform">6</button>
                    <button onclick="calculate()" class="h-12 rounded-2xl bg-kawaii-secondary text-white font-black text-lg shadow-lg shadow-blue-200 active:scale-95 transition-transform">=</button>
                    <button onclick="appendCalc('1')" class="h-12 rounded-2xl bg-white shadow-card font-black text-lg text-kawaii-text active:scale-95 transition-transform">1</button>
                    <button onclick="appendCalc('2')" class="h-12 rounded-2xl bg-white shadow-card font-black text-lg text-kawaii-text active:scale-95 transition-transform">2</button>
                    <button onclick="appendCalc('3')" class="h-12 rounded-2xl bg-white shadow-card font-black text-lg text-kawaii-text active:scale-95 transition-transform">3</button>
                    <button onclick="appendCalc('0')" class="h-12 rounded-2xl bg-white shadow-card font-black text-lg text-kawaii-text active:scale-95 transition-transform">0</button>
                </div>

                <div class="border-t border-dashed border-gray-200 pt-4 flex gap-3">
                    <input type="text" id="expense-item" placeholder="è²·äº†ä»€éº¼å‘¢..." class="flex-1 bg-gray-50 rounded-xl px-4 py-2 text-sm font-bold outline-none border border-transparent focus:border-kawaii-primary/50 transition-colors">
                    <label class="w-10 h-10 flex items-center justify-center bg-kawaii-accent rounded-xl text-white cursor-pointer shadow-md active:scale-95 transition-transform">
                        <i class="fas fa-camera"></i>
                        <input type="file" id="expense-photo" accept="image/*" class="hidden" onchange="handlePhotoUpload(this)">
                    </label>
                </div>
                
                <div class="mt-2 flex items-center justify-end gap-2 pr-1">
                    <label class="flex items-center gap-2 cursor-pointer select-none group">
                        <input type="checkbox" id="expense-is-advance" class="peer hidden">
                        <div class="w-4 h-4 rounded border-2 border-gray-300 peer-checked:bg-kawaii-secondary peer-checked:border-kawaii-secondary flex items-center justify-center transition-all bg-white group-active:scale-95">
                            <i class="fas fa-check text-white text-[10px] opacity-0 peer-checked:opacity-100"></i>
                        </div>
                        <span class="text-xs font-bold text-gray-400 peer-checked:text-kawaii-secondary transition-colors">å¹«åˆ¥äººä»£å¢Š (äº‹å¾Œç®—)</span>
                    </label>
                </div>
                
                <div id="photo-preview-container" class="hidden mt-3 relative w-full h-32 bg-gray-100 rounded-xl overflow-hidden border-2 border-white shadow-sm">
                    <img id="photo-preview" class="w-full h-full object-contain">
                    <button onclick="clearPhoto()" class="absolute top-2 right-2 bg-red-400 text-white w-6 h-6 rounded-full flex items-center justify-center font-bold shadow-md">Ã—</button>
                </div>

                <button onclick="addExpense()" class="w-full bg-kawaii-primary text-white py-3 rounded-2xl shadow-lg shadow-pink-200 mt-4 font-black tracking-wide active:scale-[0.98] transition-all flex items-center justify-center gap-2">
                    <i class="fas fa-plus-circle"></i> è¨˜ä¸‹ä¾†
                </button>
            </div>

            <div class="px-2">
                <div class="bg-gradient-to-r from-pink-50 to-white p-4 rounded-2xl border border-pink-100 shadow-sm mb-6 flex justify-between items-center relative overflow-hidden">
                    <div class="absolute -right-4 -top-4 w-16 h-16 bg-pink-200 rounded-full opacity-30 blur-xl"></div>
                    <div>
                        <div class="text-[10px] font-bold text-gray-400 mb-1">ä»£å¢Šç¸½é¡ (Advance Total)</div>
                        <div class="text-xl font-black text-gray-700">Â¥<span id="advance-total">0</span></div>
                    </div>
                    <div class="text-right z-10">
                        <div class="text-[10px] font-bold text-kawaii-primary mb-1">æ¯äººæ‡‰ä»˜ (Per Person)</div>
                        <div class="text-2xl font-black text-kawaii-primary">Â¥<span id="split-result">0</span></div>
                    </div>
                </div>

                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-black text-lg text-kawaii-text">æ”¯å‡ºç´€éŒ„</h3>
                    <span class="text-xs font-bold bg-white px-3 py-1 rounded-full shadow-sm text-gray-500">Total: <span class="text-kawaii-primary">Â¥</span><span id="total-jpy">0</span></span>
                </div>

                <div class="flex gap-2 mb-2">
                    <button onclick="syncToCloud()" id="btn-upload" class="flex-1 bg-blue-400 text-white py-2 rounded-xl font-bold text-xs shadow-md active:scale-95 transition-all flex items-center justify-center gap-1">
                        <i class="fas fa-cloud-upload-alt"></i> å‚™ä»½åˆ°é›²ç«¯
                    </button>
                    <button onclick="syncFromCloud()" id="btn-download" class="flex-1 bg-gray-400 text-white py-2 rounded-xl font-bold text-xs shadow-md active:scale-95 transition-all flex items-center justify-center gap-1">
                        <i class="fas fa-cloud-download-alt"></i> å¾é›²ç«¯é‚„åŸ
                    </button>
                </div>
                <div class="text-[10px] text-center text-gray-300 mb-2 font-mono">
                    Device ID: <span id="my-device-id">loading...</span>
                </div>
                <div id="sync-status" class="text-[10px] text-center text-gray-400 mb-4 h-4 font-bold transition-all"></div>

                <div id="expense-container" class="space-y-6 pb-8"></div>
                <button onclick="clearExpenses()" class="w-full text-center text-xs text-gray-300 mt-2 hover:text-red-300 transition-colors">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰ç´€éŒ„</button>
            </div>
        </div>

        <div id="tab-lists" class="tab-content px-1">
            <div class="bg-white rounded-[32px] p-6 shadow-soft mb-6 relative">
                <div class="w-12 h-12 bg-kawaii-green/20 rounded-full flex items-center justify-center text-kawaii-green text-xl absolute -top-4 -left-2 shadow-sm border-4 border-kawaii-base"><i class="fas fa-suitcase-rolling"></i></div>
                <h3 class="text-lg font-black mb-4 pl-10 text-kawaii-text">è¡Œææª¢æŸ¥è¡¨</h3>
                <div id="checklist-container" class="space-y-3"></div>
                <div class="mt-6 flex gap-3 relative">
                    <input type="text" id="new-todo" placeholder="æ–°å¢é …ç›®..." class="flex-1 bg-gray-50 rounded-full px-4 text-sm font-bold outline-none border-2 border-transparent focus:border-kawaii-green/50 transition-colors h-10">
                    <button onclick="addTodo()" class="bg-kawaii-green text-white w-10 h-10 rounded-full shadow-md hover:shadow-lg active:scale-90 transition-all flex items-center justify-center"><i class="fas fa-plus"></i></button>
                </div>
            </div>
            <div class="bg-[#FFFDF0] rounded-[32px] p-6 shadow-card relative border-2 border-[#FEF9E7]">
                <div class="absolute -top-3 -right-2 text-2xl rotate-12">ğŸ“</div>
                <h3 class="text-lg font-black mb-2 text-[#C9B36B]">éš¨æ‰‹è¨˜</h3>
                <textarea id="memo-area" class="w-full h-40 bg-transparent p-2 text-sm leading-8 outline-none resize-none font-bold text-[#8D7F57] placeholder-[#D8CFB4]" style="background-image: repeating-linear-gradient(transparent, transparent 31px, #EBE3CC 31px, #EBE3CC 32px); line-height: 32px;" placeholder="é€™è£¡å¯ä»¥è²¼é€£çµæˆ–å¯«æ—¥è¨˜..."></textarea>
            </div>
        </div>

        <div id="tab-info" class="tab-content space-y-5">
             <div class="bg-white rounded-3xl p-5 shadow-soft border border-gray-50">
                <div class="flex items-center gap-3 mb-4"><span class="w-8 h-8 rounded-full bg-kawaii-primary/20 flex items-center justify-center text-kawaii-primary text-xs"><i class="fas fa-bed"></i></span><h3 class="font-black text-lg text-kawaii-text">ä½å®¿è³‡è¨Š</h3></div>
                <div class="pl-2 border-l-4 border-kawaii-primary/30 ml-2"><h4 class="text-base font-black text-kawaii-text">Hotel Vista Sapporo Odori</h4><p class="text-xs text-gray-400 font-bold">ãƒ›ãƒ†ãƒ«ãƒ“ã‚¹ã‚¿æœ­å¹Œ [å¤§é€š]</p></div>
                <div class="mt-4 space-y-2 text-sm font-medium text-gray-600 bg-gray-50 p-4 rounded-2xl">
                    <div class="flex items-start gap-3"><i class="fas fa-map-marker-alt mt-1 text-kawaii-primary"></i><p class="text-xs leading-relaxed">ã€’060-0063<br>åŒ—æµ·é“æœ­å¹Œå¸‚ä¸­å¤®åŒºå—3æ¡è¥¿5ä¸ç›®16<br><span class="text-gray-400">(ç‹¸å°è·¯ 5ä¸ç›®é™„è¿‘)</span></p></div>
                </div>
                <a href="https://www.google.com/maps/search/?api=1&query=Hotel+Vista+Sapporo+Odori" target="_blank" class="mt-4 flex items-center justify-center w-full bg-white border-2 border-gray-100 text-kawaii-text py-2.5 rounded-xl font-bold text-xs shadow-sm hover:border-kawaii-primary/50 transition-colors"><i class="fas fa-location-arrow mr-2 text-kawaii-primary"></i> é–‹å•Ÿåœ°åœ–</a>
            </div>
            <div class="bg-gradient-to-br from-[#E0F7FA] to-white rounded-3xl p-5 shadow-soft relative overflow-hidden">
                <div class="absolute -right-5 -top-5 w-20 h-20 bg-blue-100 rounded-full opacity-50 blur-xl"></div>
                <h3 class="font-black text-lg mb-4 flex items-center gap-2 relative z-10 text-cyan-800"><i class="fas fa-flag text-cyan-400"></i> ä¸€æ—¥éŠé›†åˆ</h3>
                <div class="bg-white/80 backdrop-blur-sm p-4 rounded-2xl border border-white mb-3 shadow-sm">
                    <div class="flex justify-between items-start"><span class="bg-cyan-100 text-cyan-700 text-[10px] font-black px-2 py-1 rounded-md">12/22 ç™»åˆ¥æ´çˆº</span><a href="https://www.google.com/maps/search/?api=1&query=%E5%A4%A7%E9%80%9A%E5%85%AC%E5%9C%92+%E5%B8%8C%E6%9C%9B%E3%81%AE%E5%83%8F" target="_blank" class="text-cyan-400"><i class="fas fa-map-pin"></i></a></div>
                    <div class="mt-2"><div class="text-2xl font-black text-kawaii-text">08:00 <span class="text-xs font-normal text-gray-400">é›†åˆ</span></div><div class="text-sm font-bold text-gray-600">å¤§é€šå…¬åœ’ å¸Œæœ›ä¹‹åƒ</div></div>
                </div>
                <div class="bg-white/80 backdrop-blur-sm p-4 rounded-2xl border border-white shadow-sm">
                    <div class="flex justify-between items-start"><span class="bg-blue-100 text-blue-700 text-[10px] font-black px-2 py-1 rounded-md">12/23 æ—­å·ç¾ç‘›</span><a href="https://www.google.com/maps/search/?api=1&query=%E6%9C%AD%E5%B9%8C%E9%A7%85%E5%8C%97%E5%8F%A3%E5%9B%A3%E4%BD%93%E3%83%90%E3%82%B9%E4%B9%97%E3%82%8A%E5%A0%B4" target="_blank" class="text-blue-400"><i class="fas fa-map-pin"></i></a></div>
                    <div class="mt-2"><div class="text-2xl font-black text-kawaii-text">07:50 <span class="text-xs font-normal text-gray-400">é›†åˆ</span></div><div class="text-sm font-bold text-gray-600">æœ­å¹Œç«™ åŒ—å£å·´å£«ç«™</div></div>
                </div>
            </div>
            <div class="bg-white rounded-3xl p-5 shadow-soft border-l-8 border-red-200">
                 <h3 class="font-black text-lg mb-3">SOS ç·Šæ€¥è¯çµ¡</h3>
                 <div class="grid grid-cols-2 gap-3">
                     <a href="tel:110" class="bg-red-50 p-3 rounded-xl flex flex-col items-center justify-center gap-1 active:scale-95 transition-transform"><i class="fas fa-user-shield text-red-400 text-xl"></i><span class="text-xs font-black text-red-400">è­¦å¯Ÿ 110</span></a>
                     <a href="tel:119" class="bg-red-50 p-3 rounded-xl flex flex-col items-center justify-center gap-1 active:scale-95 transition-transform"><i class="fas fa-ambulance text-red-400 text-xl"></i><span class="text-xs font-black text-red-400">æ•‘è­· 119</span></a>
                 </div>
                 <div class="mt-3 bg-gray-50 rounded-xl p-3 text-center"><div class="text-[10px] text-gray-400 mb-1">é§æ—¥ç¶“æ¿Ÿæ–‡åŒ–ä»£è¡¨è™•</div><a href="tel:+81112222930" class="font-black text-gray-700">+81-11-222-2930</a></div>
            </div>
        </div>
    </main>

    <nav class="nav-bar-float fixed bottom-0 left-0 w-full pb-safe z-50">
        <div class="flex justify-around items-end h-20 px-2">
            <button class="nav-item active w-full h-full pb-2 flex flex-col items-center justify-end transition-all duration-300 group" onclick="switchTab('plan', this)">
                <div class="icon-container w-10 h-10 rounded-2xl flex items-center justify-center mb-1 transition-all duration-300 bg-transparent text-gray-400"><i class="fas fa-map-marked-alt text-lg"></i></div>
                <span class="text-[10px] font-bold text-gray-400 group-[.active]:text-kawaii-primary transition-colors">è¡Œç¨‹</span>
            </button>
            <button class="nav-item w-full h-full pb-2 flex flex-col items-center justify-end transition-all duration-300 group" onclick="switchTab('guide', this)">
                <div class="icon-container w-10 h-10 rounded-2xl flex items-center justify-center mb-1 transition-all duration-300 bg-transparent text-gray-400"><i class="fas fa-book-open text-lg"></i></div>
                <span class="text-[10px] font-bold text-gray-400 group-[.active]:text-kawaii-primary transition-colors">å°è¦½</span>
            </button>
            <button class="nav-item w-full h-full pb-2 flex flex-col items-center justify-end transition-all duration-300 group" onclick="switchTab('wallet', this)">
                <div class="icon-container w-12 h-12 rounded-[20px] flex items-center justify-center mb-1 transition-all duration-300 bg-transparent text-gray-400 -mt-4 group-[.active]:-mt-6"><i class="fas fa-wallet text-xl"></i></div>
                <span class="text-[10px] font-bold text-gray-400 group-[.active]:text-kawaii-primary transition-colors">éŒ¢åŒ…</span>
            </button>
            <button class="nav-item w-full h-full pb-2 flex flex-col items-center justify-end transition-all duration-300 group" onclick="switchTab('lists', this)">
                <div class="icon-container w-10 h-10 rounded-2xl flex items-center justify-center mb-1 transition-all duration-300 bg-transparent text-gray-400"><i class="fas fa-tasks text-lg"></i></div>
                <span class="text-[10px] font-bold text-gray-400 group-[.active]:text-kawaii-primary transition-colors">æ¸…å–®</span>
            </button>
            <button class="nav-item w-full h-full pb-2 flex flex-col items-center justify-end transition-all duration-300 group" onclick="switchTab('info', this)">
                <div class="icon-container w-10 h-10 rounded-2xl flex items-center justify-center mb-1 transition-all duration-300 bg-transparent text-gray-400"><i class="fas fa-info-circle text-lg"></i></div>
                <span class="text-[10px] font-bold text-gray-400 group-[.active]:text-kawaii-primary transition-colors">è³‡è¨Š</span>
            </button>
        </div>
    </nav>

    <script>
        // è³‡æ–™èˆ‡é‚è¼¯éƒ¨åˆ†
        
        let currentPhotoBase64 = null;
        // å°‡å„²å­˜ç‰ˆæœ¬å‡ç´šç‚º v17
        let expenses = JSON.parse(localStorage.getItem('expenses_book_2025_v17')) || [];
        let todoList = JSON.parse(localStorage.getItem('todo_book_2025_v7')) || [
            { text: "è­·ç…§ (æ•ˆæœŸ6å€‹æœˆä»¥ä¸Š) ğŸ“•", done: false },
            { text: "Visit Japan Web (æˆªåœ–å‚™ç”¨) ğŸ“±", done: false },
            { text: "æ—…éŠä¿éšª (å¹³å®‰éšª+ä¸ä¾¿éšª) ğŸ“„", done: false },
            { text: "eSIM / æ¼«éŠè¨­å®šå®Œæˆ ğŸ“¶", done: false },
            { text: "æ—¥å¹£ç¾é‡‘ & ä¿¡ç”¨å¡ (JCB/Visa) ğŸ’´", done: false },
            { text: "äº¤é€šå¡ (Suica/ICOCA) ğŸ§", done: false },
            { text: "é˜²æ»‘é›ªé´ & é˜²æ°´æ‰‹å¥— ğŸ§¤", done: false },
            { text: "é˜²å¯’è¡£ç‰© (ç™¼ç†±è¡£/æ¯›å¸½/åœå·¾) ğŸ§£", done: false },
            { text: "å€‹äººç›¥æ´— (ç‰™åˆ·/ç‰™è†) ğŸª¥", done: false },
            { text: "å……é›»å™¨ & è¡Œå‹•é›»æº (ä½æº«è€—é›»å¿«) ğŸ”‹", done: false },
            { text: "å¸¸å‚™è—¥ (æ„Ÿå†’/æšˆè»Š/å¤–å‚·/æ­¢ç—›) ğŸ’Š", done: false }
        ];

        const itineraryData = [
            {
                date: "12/20", day: "å…­", title: "å‰é€²é›ªåœ‹ âœˆï¸", active: true,
                weather: { icon: "fa-snowflake", temp: "-2Â°", desc: "å¤§é›ª" },
                events: [
                    { time: "09:10", desc: "æ¡ƒåœ’æ©Ÿå ´ (T1)", type: "transport", note: "ææ—©3hr!", highlight: true, details: "09:10å‰æŠµé”ã€‚é…·èˆªæ«ƒå°äººå¤šï¼Œè«‹ææ—©ã€‚å¡«å¯« Visit Japan Webã€‚" },
                    { time: "12:10", desc: "é…·èˆª TR892", type: "transport", details: "12:10 èµ·é£› -> 17:20 æŠµé”æ–°åƒæ­² (CTS)ã€‚" },
                    { time: "17:50", desc: "æŠµé”æ–°åƒæ­²", type: "transport", details: "æ­ä¹˜ JR å¿«é€Ÿ Airport (Â¥1,150) å‰å¾€æœ­å¹Œã€‚" },
                    { time: "19:00", desc: "æ—…é¤¨ Check-in", type: "stay", mapLink: "https://www.google.com/maps/search/?api=1&query=Hotel+Vista+Sapporo+Odori", details: "Hotel Vista Sapporo Odoriã€‚ç‹¸å°è·¯å•†åº—è¡—é™„è¿‘ã€‚" },
                    { time: "19:30", desc: "æ¹¯å’–å“© Suage+", type: "food", note: "å¿…åƒ!", details: "æ¨è–¦ï¼šä¸²ç‡’æ¹¯å’–å“©ã€‚é£¯æ³¡æ¹¯åƒã€‚" },
                    { time: "20:30", desc: "å¤œé–“è–ä»£", type: "activity", details: "æ¨è–¦ï¼šãªãªã‹ã¾å ‚ã€‚ä¹‹å¾Œé€›å”å‰è»»å¾·ã€‚" }
                ]
            },
            // --- 12/21 è¡Œç¨‹æ›´æ–° ---
            {
                date: "12/21", day: "æ—¥", title: "æœ­å¹Œå¸‚å€å·¡ç¦® â›©ï¸", active: false,
                weather: { icon: "fa-cloud-meatball", temp: "-3Â°", desc: "å¤šé›²é›ª" },
                events: [
                    { time: "07:00", desc: "è²·åœ°éµä¸€æ—¥åˆ¸", type: "transport", note: "å‡æ—¥ç‰ˆÂ¥520", details: "åœ¨åœ°éµå”®ç¥¨æ©Ÿè³¼è²·ã€Œãƒ‰ãƒ‹ãƒã‚«ã‚­ãƒƒãƒ—ã€(Donichika Ticket)ï¼Œä»Šæ—¥åœ°éµç„¡é™æ­ä¹˜ã€‚" },
                    { time: "08:30", desc: "äºŒæ¡å¸‚å ´ & å¸‚å€æ•£æ­¥", type: "walk", details: "äºŒæ¡å¸‚å ´ â†’ æœ­å¹Œå¸‚æ™‚è¨ˆå° â†’ åŒ—æµ·é“å»³ç´…ç£šå»³èˆã€‚é€™å¹¾å€‹é»æ—©ä¸Šäººå°‘å¥½æ‹ç…§ã€‚" },
                    { time: "10:00", desc: "æ ¹å®¤èŠ±ä¸¸ (æŠ½è™Ÿç¢¼ç‰Œ)", type: "food", highlight: true, note: "Miredoåº—", details: "11:00ç‡Ÿæ¥­ï¼Œ10:00å…ˆå»æŠ½è™Ÿç¢¼ç‰Œã€‚åœ°é»ï¼šå¤§åŒç”Ÿå‘½æœ­å¹Œå¤§æ¨“ Miredoåº—ã€‚" },
                    { time: "10:10", desc: "å…­èŠ±äº­ & åŒ—è“æ¨“", type: "shop", details: "åˆ©ç”¨ç­‰å¾…æ™‚é–“é€›é€›ã€‚åŒ—è“æ¨“æœ¬é¤¨(å®‰è—¤å¿ é›„è¨­è¨ˆ)å¿…åƒæ³¡èŠ™ï¼›å…­èŠ±äº­æœ¬åº—è²·é™å®šå†°æ·‡æ·‹é¤…ä¹¾ã€‚" },
                    { time: "11:00", desc: "æ ¹å®¤èŠ±ä¸¸ è¿´è½‰å£½å¸", type: "food", details: "åŒ—æµ·é“å¿…åƒè¿´è½‰å£½å¸ï¼" },
                    { time: "14:00", desc: "è«è¨ªç¥ç¤¾", type: "spot", details: "åœ°éµã€ŒåŒ—13æ¡æ±ã€ç«™ã€‚å¿…è²·è¶…å¯æ„›ã€ŒéŠ€å–‰é•·å°¾å±±é›€ã€å¾¡å®ˆï¼" },
                    { time: "15:00", desc: "åŒ—æµ·é“å¤§å­¸", type: "spot", details: "å» Marche CafÃ© & Labo åƒè¾²å ´å†°æ·‡æ·‹ã€è²·é™å®šå¸ƒä¸ã€‚" },
                    { time: "16:00", desc: "ç‹¸å°è·¯é€›è¡—", type: "shop", details: "æ—…é¤¨æ—é‚Šçš„ç‹¸å°è·¯å•†åº—è¡—é€›ä¸€ä¸‹ï¼Œæ™‚é–“å¿«åˆ°å†èµ°å»é™„è¿‘çš„é¤å»³ã€‚" },
                    { time: "17:00", desc: "ã ã—åŠ‡å ´ (é—œæ±ç…®)", type: "food", highlight: true, note: "å·²é ç´„", details: "ã ã—åŠ‡å ´ã€‡â–³â–¡ ã™ã™ãã®é§…å‰åº—ã€‚é—œæ±ç…®åƒåˆ°é£½å±…é…’å±‹ã€‚" },
                    { time: "18:30", desc: "è–èª•å¸‚é›† & é›»è¦–å¡”", type: "spot", details: "å¤§é€šå…¬åœ’æ…•å°¼é»‘è–èª•å¸‚é›†ã€‚ä¸Šé›»è¦–å¡”çœ‹å¤œæ™¯(ç”¨å¥—ç¥¨)ã€‚" },
                    { time: "20:00", desc: "ç‹¸å°è·¯ & åœ°ä¸‹è¡—", type: "shop", details: "æœ€å¾Œé€›è¡—è£œè²¨ï¼Œèµ°åœ°ä¸‹è¡—å›é£¯åº—ã€‚" }
                ]
            },
            {
                date: "12/22", day: "ä¸€", title: "ç™»åˆ¥æ´çˆºä¸€æ—¥éŠ ğŸšŒ", active: false,
                weather: { icon: "fa-cloud-sun", temp: "-1Â°", desc: "æ™´æ™‚é›²" },
                events: [
                    { time: "07:40", desc: "é›†åˆï¼šå¤§é€šå…¬åœ’", type: "transport", highlight: true, note: "è¥¿3ä¸ç›®", details: "08:00 æº–æ™‚ç™¼è»Šã€‚å¤§é€šå…¬åœ’è¥¿3ä¸ç›®ï¼ˆ31è™Ÿå‡ºå£ï¼‰ã€‚" },
                    { time: "09:50", desc: "ç™»åˆ¥åœ°ç„è°· â™¨ï¸", type: "spot", details: "ç«å±±åœ°å½¢ï¼Œèµ°è·¯å°å¿ƒã€‚" },
                    { time: "11:50", desc: "ç†Šç‰§å ´ ğŸ»", type: "spot", details: "å¯ä»¥é¤µç†Šåƒè˜‹æœã€‚" },
                    { time: "13:40", desc: "æ´çˆºæ¹–", type: "spot", details: "æ¬£è³æ¹–å…‰å±±è‰²ã€‚" },
                    { time: "19:00", desc: "JRå¡”å¤œæ™¯", type: "spot", details: "T38 å±•æœ›å°çœ‹å¤œæ™¯ã€‚" }
                ]
            },
            {
                date: "12/23", day: "äºŒ", title: "æ—­å·ç¾ç‘›å¤¢å¹»éŠ ğŸ§", active: false,
                weather: { icon: "fa-snowflake", temp: "-6Â°", desc: "å¤§é›ª" },
                events: [
                    { time: "07:50", desc: "é›†åˆï¼šæœ­å¹ŒåŒ—å£", type: "transport", highlight: true, details: "æœ­å¹Œç«™åŒ—å£å·´å£«åœè»Šå ´ã€‚" },
                    { time: "10:30", desc: "æ—­å±±å‹•ç‰©åœ’", type: "spot", details: "11:00 ä¼éµæ•£æ­¥ï¼" },
                    { time: "13:10", desc: "ç¾ç‘›é’æ± ", type: "spot", details: "å†¬å­£çµå†°é»ç‡ˆçš„é’æ± ã€‚" },
                    { time: "15:00", desc: "ç²¾éˆéœ²å°", type: "spot", details: "åƒç«¥è©±ä¸–ç•Œä¸€æ¨£çš„å°æœ¨å±‹ã€‚" },
                    { time: "19:30", desc: "å¸ç‹èŸ¹åƒåˆ°é£½ ğŸ¦€", type: "food", highlight: true, note: "èŸ¹åº§", details: "å¤§å£åƒèƒèŸ¹ï¼" }
                ]
            },
            {
                date: "12/24", day: "ä¸‰", title: "ç™½è‰²è–èª•å¤œ ğŸ„", active: false,
                weather: { icon: "fa-snowflake", temp: "-2Â°", desc: "é£„é›ª" },
                events: [
                    { time: "08:30", desc: "ç¾Šä¹‹ä¸˜å±•æœ›å°", type: "activity", details: "å…è²»é«”é©—ç©é›ªã€‚" },
                    { time: "12:00", desc: "æ‹‰éºµæ©«ä¸", type: "food", details: "æ¨è–¦ï¼šå¼Ÿå­å±ˆæ‹‰éºµã€‚" },
                    { time: "14:00", desc: "åŒ—æµ·é“ç¥å®®", type: "spot", details: "å¿…åƒå…­èŠ±äº­åˆ¤å®˜å¤§äººéº»ç³¬ã€‚" },
                    { time: "16:00", desc: "ç™½è‰²æˆ€äººå…¬åœ’", type: "spot", note: "è–èª•é»ç‡ˆ", details: "æ­é¢¨åº­åœ’éå¸¸æ¼‚äº®ã€‚" },
                    { time: "18:30", desc: "çˆç«¯ç‡’æ™šé¤", type: "food", highlight: true, details: "Kakureya æ°£æ°›æ»¿åˆ†ã€‚" },
                    { time: "20:30", desc: "AOAO æ°´æ—é¤¨", type: "spot", details: "moyuk å•†å ´å…§ã€‚" }
                ]
            },
            {
                date: "12/25", day: "å››", title: "å°æ¨½æµªæ¼«æ¼«æ­¥ ğŸ•¯ï¸", active: false,
                weather: { icon: "fa-cloud", temp: "-3Â°", desc: "é™°å¤©" },
                events: [
                    { time: "09:10", desc: "å‰å¾€å°æ¨½", type: "transport", details: "æ­ä¹˜ JR å¿«é€Ÿ Airportã€‚" },
                    { time: "10:00", desc: "å°æ¨½é‹æ²³", type: "walk", details: "åŒ—è“æ¨“ã€LeTAOã€éŸ³æ¨‚ç›’å ‚ã€‚" },
                    { time: "12:00", desc: "è‹¥é›æ™‚ä»£", type: "food", details: "å¿…åƒç‚¸åŠé›å®šé£Ÿï¼" },
                    { time: "16:00", desc: "è—»å²©å±±å¤œæ™¯", type: "spot", details: "æ–°æ—¥æœ¬ä¸‰å¤§å¤œæ™¯ã€‚" },
                    { time: "19:00", desc: "æœ€å¾Œæ¡è²·", type: "shop", details: "æŠŠæ—¥å¹£èŠ±å…‰å…‰ï¼" }
                ]
            },
            {
                date: "12/26", day: "äº”", title: "å†è¦‹åŒ—æµ·é“ ğŸ‘‹", active: false,
                weather: { icon: "fa-sun", temp: "-1Â°", desc: "æ™´å¤©" },
                events: [
                    { time: "08:30", desc: "å‰å¾€æ©Ÿå ´", type: "transport", details: "æ­å·´å£«æˆ– JRã€‚å»ºè­° 12:20 åˆ°æ©Ÿå ´ã€‚" },
                    { time: "10:50", desc: "æ©Ÿå ´é€›è¡—", type: "shop", details: "å“†å•¦Aå¤¢ç©ºä¸­æ¨‚åœ’ã€Royceã€‚" },
                    { time: "12:00", desc: "ä¸€å¹»æ‹‰éºµ", type: "food", details: "è¶…æ¿ƒéƒè¦æ¹¯ã€‚" },
                    { time: "15:20", desc: "é•·æ¦® BR115", type: "transport", highlight: true, note: "å›å°åŒ—", details: "å¹³å®‰å›å®¶ã€‚" }
                ]
            }
        ];

        const guideData = [
            { title: "å°æ¨½å ºç”ºé€šã‚Šå•†åº—è¡—", content: "å……æ»¿æ‡·èˆŠé¢¨æƒ…çš„å¿…é€›è¡—é“ï¼é€™æ¢è¡—ä¸Šæœ‰è‘—åçš„ã€Œå°æ¨½éŸ³æ¨‚ç›’å ‚ã€ã€ã€ŒåŒ—ä¸€ç¡å­ã€ç»ç’ƒå·¥åŠï¼Œé‚„æœ‰è¶…å¥½åƒçš„ã€ŒLeTAOã€èµ·å¸è›‹ç³•ç¸½åº—ã€‚æƒ³è²·ä¼´æ‰‹ç¦®ä¾†é€™è£¡æº–æ²’éŒ¯ï¼", tags: ["è³¼ç‰©", "æ•£æ­¥", "å°æ¨½"] },
            { title: "å¤§ä¸¸æœ­å¹Œåº— (Daimaru)", content: "èˆ‡æœ­å¹Œè»Šç«™ç›´çµï¼Œéå¸¸å¥½é€›ï¼8æ¨“æœ‰å¿…å»çš„ã€ŒPokÃ©mon Center Sapporo (å¯¶å¯å¤¢ä¸­å¿ƒ)ã€ï¼ŒB1 åœ°ä¸‹é£Ÿå“è¡— (Depachika) æ›´æ˜¯ç¾é£Ÿå¤©å ‚ï¼Œå„ç¨®ç”œé»ä¾¿ç•¶æ‡‰æœ‰ç›¡æœ‰ã€‚", tags: ["å¯¶å¯å¤¢", "ç¾é£Ÿ", "ä¼´æ‰‹ç¦®"] },
            { title: "ç‹¸å°è·¯å•†åº—è¡—", content: "æœ­å¹Œæœ€ç¶“å…¸çš„å•†åº—è¡—ï¼Œå¾1ä¸ç›®åˆ°7ä¸ç›®éƒ½æœ‰å±‹é ‚ï¼Œä¸‹å¤§é›ªä¹Ÿä¸æ€•ï¼è—¥å¦åº—(å¦‚æ¾æœ¬æ¸…ã€æœ­å¹Œè—¥å¦)ã€å”å‰è»»å¾·éƒ½åœ¨é€™è£¡ï¼Œæ˜¯æƒè²¨çš„è–åœ°ã€‚", tags: ["è—¥å¦", "å¿…é€›", "é›¨å‚™"] },
            { title: "æœ­å¹Œå·¥å»  (Sapporo Factory)", content: "ç”±ç´…ç£šå•¤é…’å» æ”¹å»ºçš„è³¼ç‰©ä¸­å¿ƒï¼Œä¿ç•™äº†å·¨å¤§çš„ç…™å›ªã€‚ä¸­åº­ (Atrium) éå¸¸æŒ‘é«˜å¯¬æ•ï¼Œå†¬å­£æœƒæœ‰å·¨å¤§çš„å®¤å…§è–èª•æ¨¹ï¼Œæ°£æ°›è¶…ç´šæµªæ¼«ï¼", tags: ["ç´…ç£š", "æ‹ç…§", "å®¤å…§"] },
            { title: "ç™½è‰²æˆ€äººå…¬åœ’", content: "ä¸åªæ˜¯è³£é¤…ä¹¾ï¼Œæ›´åƒä¸€åº§é›ªåœ‹åŸå ¡ï¼å†¬å­£åº­åœ’æœ‰ç››å¤§é»ç‡ˆï¼Œä¸€å®šè¦åœ¨æˆ¶å¤–æ„›å¿ƒæ‹±é–€æ‹ç…§ã€‚", tags: ["æµªæ¼«", "å¿…å»"] },
            { title: "ä¼éµæ•£æ­¥", content: "æ—­å±±å‹•ç‰©åœ’å†¬å­£é™å®šï¼çœ‹è‘—åœ‹ç‹ä¼éµæ–æ–æ™ƒæ™ƒèµ°åœ¨é›ªé“ä¸Šï¼ŒèŒç¿»å¤©ã€‚", tags: ["å‹•ç‰©", "é™å®š"] },
            { title: "å°æ¨½é‹æ²³", content: "é»ƒæ˜æ™‚åˆ†ç…¤æ°£ç‡ˆäº®èµ·æ˜¯æœ€æµªæ¼«çš„æ™‚åˆ»ã€‚ç«™åœ¨ã€Œæ·ºè‰æ©‹ã€ä¸Šå¯ä»¥æ‹åˆ°æœ€ç¶“å…¸è§’åº¦ã€‚", tags: ["æ‹ç…§", "å¤œæ™¯"] },
            { title: "æ”¶å°¾è–ä»£", content: "æœ­å¹Œæ–‡åŒ–ï¼šå–é…’å¾Œåƒã€Œè–ä»£ã€åšçµå°¾ï¼å£æ„Ÿå±¤æ¬¡è±å¯Œï¼Œæ˜¯å¤§äººçš„ç”œé»ã€‚", tags: ["ç¾é£Ÿ", "æ–‡åŒ–"] },
            { title: "ç²¾éˆéœ²å°", content: "å¯Œè‰¯é‡æ£®æ—è£¡çš„å°æœ¨å±‹ï¼Œé»ç‡ˆå¾Œåƒç²¾éˆå±…ä½çš„å¤¢å¹»åœ‹åº¦ã€‚", tags: ["å¤¢å¹»", "æ‰‹ä½œ"] }
        ];

        // æ ¸å¿ƒé‚è¼¯
        function getDeviceId() {
            let id = localStorage.getItem('my_device_id');
            if (!id) {
                id = 'user_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('my_device_id', id);
            }
            return id;
        }

        window.onload = function () {
            renderPlanTabs();
            renderTimeline(0);
            renderGuide();
            renderExpenses();
            renderTodoList();
            
            document.getElementById('my-device-id').innerText = getDeviceId();

            const savedCount = localStorage.getItem('traveler_count_v11');
            if (savedCount) document.getElementById('traveler-count').value = savedCount;
            updateSplitCalc();

            const savedMemo = localStorage.getItem('memo_book_2025_v1');
            if (savedMemo) document.getElementById('memo-area').value = savedMemo;

            document.getElementById('memo-area').addEventListener('input', function() {
                localStorage.setItem('memo_book_2025_v1', this.value);
            });

            document.getElementById('exchange-rate').addEventListener('input', calculate);
            document.getElementById('calc-input').addEventListener('input', calculate);
        };

        function switchTab(tabId, btn) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            btn.classList.add('active');
            window.scrollTo(0, 0);
        }
        function renderPlanTabs() {
            const container = document.getElementById('date-scroll');
            container.innerHTML = '';
            itineraryData.forEach((item, index) => {
                const btn = document.createElement('button');
                const isActive = index === 0;
                btn.className = `flex-shrink-0 w-[4.5rem] py-2 text-center transition-all rounded-full flex flex-col items-center justify-center gap-0.5 group ${isActive ? 'bg-kawaii-primary text-white shadow-lg shadow-pink-200 scale-105' : 'bg-white text-gray-400 border border-gray-100'}`;
                btn.innerHTML = `<span class="text-[10px] font-bold opacity-80">${item.date}</span><span class="text-base font-black">${item.day}</span>`;
                btn.onclick = () => {
                    Array.from(container.children).forEach(c => {
                        c.className = 'flex-shrink-0 w-[4.5rem] py-2 text-center transition-all rounded-full flex flex-col items-center justify-center gap-0.5 group bg-white text-gray-400 border border-gray-100';
                    });
                    btn.className = 'flex-shrink-0 w-[4.5rem] py-2 text-center transition-all rounded-full flex flex-col items-center justify-center gap-0.5 group bg-kawaii-primary text-white shadow-lg shadow-pink-200 scale-105';
                    renderTimeline(index);
                };
                container.appendChild(btn);
            });
        }
        function renderTimeline(index) {
            const dayData = itineraryData[index];
            const container = document.getElementById('itinerary-container');
            let html = `<div class="timeline-line"></div>`;
            html += `<div class="mb-6 ml-10"><div class="flex justify-between items-center pr-2"><h2 class="text-2xl font-black text-kawaii-text tracking-wide">${dayData.title}</h2><div class="flex flex-col items-center bg-white px-3 py-1.5 rounded-2xl shadow-sm border border-gray-50"><i class="fas ${dayData.weather.icon} text-kawaii-secondary text-lg mb-1"></i><span class="text-xs font-bold text-gray-400">${dayData.weather.temp}</span></div></div></div>`;
            dayData.events.forEach((event, idx) => {
                const hasDetails = event.details ? true : false;
                const eventId = `event-${idx}`;
                let iconClass = 'fa-circle'; let iconColor = 'text-gray-300'; let circleBg = 'bg-white'; let circleBorder = 'border-gray-200';
                if (event.type === 'transport') { iconClass = 'fa-train'; iconColor = 'text-white'; circleBg = 'bg-kawaii-secondary'; circleBorder = 'border-kawaii-secondary'; }
                else if (event.type === 'food') { iconClass = 'fa-utensils'; iconColor = 'text-white'; circleBg = 'bg-kawaii-primary'; circleBorder = 'border-kawaii-primary'; }
                else if (event.type === 'stay') { iconClass = 'fa-bed'; iconColor = 'text-white'; circleBg = 'bg-kawaii-purple'; circleBorder = 'border-kawaii-purple'; }
                else if (event.type === 'spot') { iconClass = 'fa-camera'; iconColor = 'text-white'; circleBg = 'bg-kawaii-green'; circleBorder = 'border-kawaii-green'; }
                else if (event.type === 'shop') { iconClass = 'fa-shopping-bag'; iconColor = 'text-white'; circleBg = 'bg-kawaii-accent'; circleBorder = 'border-kawaii-accent'; }
                else if (event.type === 'walk') { iconClass = 'fa-walking'; iconColor = 'text-white'; circleBg = 'bg-orange-300'; circleBorder = 'border-orange-300'; }
                html += `<div class="relative pl-10 pb-5 z-10 group"><div class="absolute left-[18px] top-4 w-6 h-6 ${circleBg} ${circleBorder} border-2 rounded-full flex items-center justify-center z-20 shadow-md transform transition-transform group-hover:scale-110"><i class="fas ${iconClass} ${iconColor} text-[10px]"></i></div><div class="kawaii-card p-4 bg-white relative cursor-pointer active:scale-[0.98]" onclick="${hasDetails ? `toggleDetails('${eventId}', this)` : ''}">${event.highlight ? '<div class="absolute top-0 right-0 bg-kawaii-accent text-white text-[10px] font-black px-3 py-1 rounded-bl-xl rounded-tr-lg shadow-sm">IMPORTANT</div>' : ''}<div class="flex items-baseline gap-3 mb-1"><span class="font-black text-xl text-kawaii-text font-mono opacity-80">${event.time}</span></div><h4 class="text-base font-bold text-gray-700 mb-1 leading-snug">${event.desc}</h4>${event.note ? `<p class="text-xs text-kawaii-primary font-bold flex items-center gap-1"><i class="fas fa-star"></i> ${event.note}</p>` : ''}${hasDetails ? `<div id="${eventId}" class="event-details text-sm text-gray-500"><p class="mb-3 leading-relaxed bg-gray-50 p-3 rounded-xl">${event.details}</p><div class="flex gap-2">${event.mapLink ? `<a href="${event.mapLink}" target="_blank" class="px-3 py-1 bg-blue-50 text-blue-400 rounded-full text-xs font-bold hover:bg-blue-100 transition-colors" onclick="event.stopPropagation()">ğŸ“ åœ°åœ–</a>` : ''}</div></div><div class="absolute bottom-2 right-3 opacity-20 text-gray-400 expand-icon transition-transform duration-300"><i class="fas fa-chevron-down"></i></div>` : ''}</div></div>`;
            });
            container.innerHTML = html;
        }
        function toggleDetails(id, card) { const details = document.getElementById(id); if (!details) return; card.classList.toggle('expanded'); const icon = card.querySelector('.expand-icon'); if (icon) icon.style.transform = card.classList.contains('expanded') ? 'rotate(180deg)' : 'rotate(0)'; }
        function renderGuide() {
            const container = document.getElementById('guide-container');
            let html = '';
            guideData.forEach((item, index) => {
                const colors = ['bg-red-50', 'bg-blue-50', 'bg-green-50', 'bg-purple-50', 'bg-yellow-50'];
                const color = colors[index % colors.length];
                html += `<div class="kawaii-card p-5 ${color} border-none"><div class="flex gap-2 mb-3">${item.tags.map(t => `<span class="text-[10px] font-bold bg-white/60 text-gray-500 px-2 py-1 rounded-full backdrop-blur-sm">#${t}</span>`).join('')}</div><h3 class="text-lg font-black text-gray-700 mb-2">${item.title}</h3><p class="text-sm text-gray-600 leading-relaxed font-medium">${item.content}</p></div>`;
            });
            container.innerHTML = html;
        }
        function appendCalc(val) { document.getElementById('calc-input').value += val; calculate(); }
        function clearCalc() { document.getElementById('calc-input').value = ""; calculate(); }
        function calculate() {
            const input = document.getElementById('calc-input').value;
            const rate = parseFloat(document.getElementById('exchange-rate').value) || 0.201;
            if(input.trim() === "") { document.getElementById('calc-result-twd').innerText = "0"; document.getElementById('calc-result-jpy').innerText = "0"; return; }
            try { if (/^[0-9+\-*/().\s]+$/.test(input)) { const jpy = new Function('return ' + input)(); if (isFinite(jpy)) { document.getElementById('calc-result-jpy').innerText = Math.round(jpy); document.getElementById('calc-result-twd').innerText = Math.round(jpy * rate).toLocaleString(); } } } catch (e) {}
        }
        function handlePhotoUpload(input) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = function (e) { const img = new Image(); img.onload = function () { const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); const maxSize = 300; let width = img.width; let height = img.height; if (width > height) { if (width > maxSize) { height *= maxSize / width; width = maxSize; } } else { if (height > maxSize) { width *= maxSize / height; height = maxSize; } } canvas.width = width; canvas.height = height; ctx.drawImage(img, 0, 0, width, height); currentPhotoBase64 = canvas.toDataURL('image/jpeg', 0.6); document.getElementById('photo-preview').src = currentPhotoBase64; document.getElementById('photo-preview-container').classList.remove('hidden'); }; img.src = e.target.result; }; reader.readAsDataURL(input.files[0]); } }
        function clearPhoto() { document.getElementById('expense-photo').value = ""; document.getElementById('photo-preview-container').classList.add('hidden'); currentPhotoBase64 = null; }
        function addExpense() {
            const item = document.getElementById('expense-item').value; const amountStr = document.getElementById('calc-result-jpy').innerText; const amount = parseInt(amountStr) || 0; const isAdvance = document.getElementById('expense-is-advance').checked;
            if (!item || amount <= 0) { alert("è«‹è¼¸å…¥é …ç›®å’Œé‡‘é¡å–”ï¼ğŸ¥º"); return; }
            expenses.unshift({ id: Date.now(), item: item, amount: amount, image: currentPhotoBase64, date: new Date().toLocaleDateString(), isAdvance: isAdvance });
            localStorage.setItem('expenses_book_2025_v17', JSON.stringify(expenses)); renderExpenses(); updateSplitCalc();
            document.getElementById('expense-item').value = ""; document.getElementById('calc-input').value = ""; document.getElementById('calc-result-jpy').innerText = "0"; document.getElementById('calc-result-twd').innerText = "0"; document.getElementById('expense-is-advance').checked = false; clearPhoto();
        }
        function updateSplitCalc() {
            const travelerCount = parseInt(document.getElementById('traveler-count').value) || 2; localStorage.setItem('traveler_count_v11', travelerCount);
            let totalAdvance = 0; expenses.forEach(ex => { if(ex.isAdvance) totalAdvance += ex.amount; });
            const perPerson = Math.round(totalAdvance / travelerCount);
            document.getElementById('advance-total').innerText = totalAdvance.toLocaleString(); document.getElementById('split-result').innerText = perPerson.toLocaleString();
        }
        function renderExpenses() {
            const container = document.getElementById('expense-container'); const totalEl = document.getElementById('total-jpy'); container.innerHTML = ''; let total = 0;
            const grouped = {}; expenses.forEach((ex) => { total += ex.amount; if (!grouped[ex.date]) grouped[ex.date] = []; grouped[ex.date].push(ex); });
            for (const [date, items] of Object.entries(grouped)) {
                const groupDiv = document.createElement('div');
                groupDiv.innerHTML = `<div class="sticky top-0 bg-kawaii-base/95 backdrop-blur z-10 py-2 mb-2 border-b border-gray-100 flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-kawaii-accent"></span><h4 class="font-black text-gray-500 text-sm">${date}</h4></div>`;
                const listUl = document.createElement('ul'); listUl.className = "space-y-3";
                items.forEach((ex) => {
                    const originalIndex = expenses.findIndex(e => e.id === ex.id);
                    const li = document.createElement('li'); li.className = "bg-white p-3 rounded-2xl flex items-center gap-3 shadow-card border border-gray-50";
                    const advanceTag = ex.isAdvance ? `<span class="bg-kawaii-secondary/20 text-kawaii-secondary text-[10px] px-1.5 py-0.5 rounded-md mr-1 font-black">[ä»£å¢Š]</span>` : '';
                    li.innerHTML = `<div class="w-10 h-10 rounded-xl overflow-hidden bg-gray-100 flex-shrink-0 flex items-center justify-center">${ex.image ? `<img src="${ex.image}" class="w-full h-full object-cover">` : `<i class="fas fa-shopping-basket text-gray-300"></i>`}</div><div class="flex-1 min-w-0"><div class="flex justify-between items-baseline"><h4 class="text-sm font-bold text-gray-700 truncate">${advanceTag}${ex.item}</h4><span class="font-black text-sm text-kawaii-text">Â¥${ex.amount.toLocaleString()}</span></div></div><button onclick="deleteExpense(${originalIndex})" class="w-8 h-8 rounded-full bg-red-50 text-red-300 hover:bg-red-100 flex items-center justify-center transition-colors"><i class="fas fa-trash-alt text-xs"></i></button>`;
                    listUl.appendChild(li);
                });
                groupDiv.appendChild(listUl); container.appendChild(groupDiv);
            }
            totalEl.innerText = total.toLocaleString(); updateSplitCalc();
        }
        function deleteExpense(index) { if (confirm("è¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ")) { expenses.splice(index, 1); localStorage.setItem('expenses_book_2025_v17', JSON.stringify(expenses)); renderExpenses(); } }
        function clearExpenses() { if (confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰ç´€éŒ„å—ï¼Ÿ")) { expenses = []; localStorage.setItem('expenses_book_2025_v17', JSON.stringify(expenses)); renderExpenses(); } }
        function renderTodoList() {
            const container = document.getElementById('checklist-container'); container.innerHTML = '';
            todoList.forEach((todo, index) => {
                const div = document.createElement('div'); div.className = "flex items-center gap-3 p-2 hover:bg-gray-50 rounded-lg transition-colors group";
                div.innerHTML = `<div class="relative flex items-center justify-center w-5 h-5"><input type="checkbox" class="peer appearance-none w-5 h-5 border-2 border-gray-300 rounded-md checked:bg-kawaii-green checked:border-kawaii-green transition-colors cursor-pointer" ${todo.done ? 'checked' : ''} onchange="toggleTodo(${index})"><i class="fas fa-check text-white text-xs absolute pointer-events-none opacity-0 peer-checked:opacity-100 transition-opacity"></i></div><span class="text-sm font-bold text-gray-600 flex-1 ${todo.done ? 'line-through text-gray-300' : ''}">${todo.text}</span><button onclick="removeTodo(${index})" class="text-gray-200 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity"><i class="fas fa-times"></i></button>`;
                container.appendChild(div);
            });
        }
        function toggleTodo(index) { todoList[index].done = !todoList[index].done; saveTodo(); }
        function addTodo() { const input = document.getElementById('new-todo'); const text = input.value.trim(); if (text) { todoList.push({ text: text, done: false }); saveTodo(); input.value = ''; } }
        function removeTodo(index) { todoList.splice(index, 1); saveTodo(); }
        function saveTodo() { localStorage.setItem('todo_book_2025_v7', JSON.stringify(todoList)); renderTodoList(); }

        const GAS_URL = "https://script.google.com/macros/s/AKfycbynC94_BpKWXOL9379FVXkTwfx147C7f6p6XdJcLYDZJhxAUlNqKzum7Zr8q7BA-Dag/exec";

        async function syncToCloud() {
            const status = document.getElementById('sync-status');
            const btn = document.getElementById('btn-upload');
            const myId = getDeviceId();
            
            if (!navigator.onLine) { alert("ç›®å‰æ²’æœ‰ç¶²è·¯ï¼Œç„¡æ³•å‚™ä»½å–”ï¼â˜”"); return; }
            if(expenses.length === 0 && !confirm("ç›®å‰çš„ç´€éŒ„æ˜¯ç©ºçš„ï¼Œç¢ºå®šè¦è¦†è“‹é›²ç«¯è³‡æ–™å—ï¼Ÿ")) return;

            try {
                status.innerText = "æ­£åœ¨ä¸Šå‚³è³‡æ–™åˆ°é›²ç«¯... â˜ï¸";
                btn.disabled = true;
                btn.classList.add('opacity-50');

                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify({ 
                        deviceId: myId, 
                        expenses: expenses 
                    })
                });
                
                status.innerText = "âœ… å‚™ä»½è«‹æ±‚å·²ç™¼é€ (è«‹ç¨å¾Œæª¢æŸ¥)";
                setTimeout(() => status.innerText = "", 3000);

            } catch (error) {
                console.error(error);
                status.innerText = "âŒ ä¸Šå‚³å¤±æ•—";
                alert("ä¸Šå‚³å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚");
            } finally {
                btn.disabled = false;
                btn.classList.remove('opacity-50');
            }
        }

        async function syncFromCloud() {
            const status = document.getElementById('sync-status');
            const btn = document.getElementById('btn-download');
            const myId = getDeviceId();

            if (!navigator.onLine) { alert("æ²’æœ‰ç¶²è·¯ç„¡æ³•ä¸‹è¼‰å–”ï¼"); return; }
            if (!confirm("ç¢ºå®šè¦å¾é›²ç«¯é‚„åŸå—ï¼Ÿ\nâš ï¸ é€™å°‡æœƒè¦†è“‹æ‰ç›®å‰æ‰‹æ©Ÿä¸Šçš„ç´€éŒ„ï¼")) return;

            try {
                status.innerText = "æ­£åœ¨ä¸‹è¼‰é›²ç«¯è³‡æ–™... ğŸ“¥";
                btn.disabled = true;
                btn.classList.add('opacity-50');

                const response = await fetch(`${GAS_URL}?deviceId=${myId}`);
                const data = await response.json();

                if (Array.isArray(data)) {
                    expenses = data;
                    localStorage.setItem('expenses_book_2025_v17', JSON.stringify(expenses));
                    renderExpenses();
                    updateSplitCalc();
                    status.innerText = "âœ… é‚„åŸæˆåŠŸï¼";
                } else {
                    throw new Error("Data format error");
                }
                setTimeout(() => status.innerText = "", 3000);

            } catch (error) {
                console.error(error);
                status.innerText = "âŒ ä¸‹è¼‰å¤±æ•—";
                alert("è®€å–å¤±æ•—ï¼Œå¯èƒ½æ˜¯é›²ç«¯é‚„æ²’æœ‰æ‚¨çš„å‚™ä»½è³‡æ–™å–”ï¼");
            } finally {
                btn.disabled = false;
                btn.classList.remove('opacity-50');
            }
        }

        window.addEventListener('online', () => {
            document.getElementById('sync-status').innerText = "ç¶²è·¯å·²é€£ç·š ğŸ“¶";
            setTimeout(() => document.getElementById('sync-status').innerText = "", 2000);
        });
    </script>
</body>
</html>